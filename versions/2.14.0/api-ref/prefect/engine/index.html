
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Prefect Python API for client-side execution and orchestration of flows and tasks.">
      
      
      
        <link rel="canonical" href="https://docs.prefect.io/latest/api-ref/prefect/engine/">
      
      
        <link rel="prev" href="../context/">
      
      
        <link rel="next" href="../exceptions/">
      
      
        
      
      
      <link rel="icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.2.6+insiders-4.40.2">
    
    
      
        <title>prefect.engine - Prefect Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.b13eea88.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.da3f46a0.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/theme.css">
    
      <link rel="stylesheet" href="../../../stylesheets/admonitions.css">
    
      <link rel="stylesheet" href="../../../stylesheets/api_ref.css">
    
      <link rel="stylesheet" href="../../../stylesheets/rest_ref.css">
    
      <link rel="stylesheet" href="../../../stylesheets/syntax_highlights.css">
    
      <link rel="stylesheet" href="../../../stylesheets/termynal.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    

      
  


  <script src="../../../assets/external/cdn.amplitude.com/libs/analytics-browser-1.9.1-min.js.gz.js"></script>
<script type="text/javascript">
const amplitudeKey = "c97dd2acbf306ab7bf54aca0aeb7ffa1"
const amplitudeUrl = "/2/httpapi"

const addUrl = (event) => {
  const deviceId = amplitude.getDeviceId()
  const { href = '' } = event.target
  const url = new URL(href)
  url.searchParams.set('deviceId', deviceId)
  event.target.href = url.toString()
}

const removeUrl = (event) => {
  const { href = '' } = event.target
  const url = new URL(href)
  url.searchParams.delete('deviceId')
  event.target.href = url.toString()
}

const urls = [
  'https://app.prefect.cloud',
  'https://app.stg.prefect.dev',
  'https://app.prefect.dev',
]

const selector = urls.map((url) => `a[href^="${url}"]`).join(',')

const addDeviceIdToAppLinks = () => {
  const elements = document.querySelectorAll(selector)

  elements.forEach((element) => {
    element.addEventListener('mouseenter', addUrl)
    element.addEventListener('mouseleave', removeUrl)
    element.addEventListener('focus', addUrl)
    element.addEventListener('blur', removeUrl)
    element.addEventListener('touchstart', addUrl)
    element.addEventListener('touchend', removeUrl)
  })
}


const init = () => {
  amplitude.init(amplitudeKey, undefined, {
    useBatch: true,
    serverUrl: amplitudeUrl,
    attribution: {
      disabled: false,
      trackNewCampaigns: true,
      trackPageViews: true,
      resetSessionOnNewCampaign: true,
    },
    defaultTracking: {
      pageViews: {
        trackOn: function() { return true},
        eventType: "Page View: Docs",
        trackHistoryChanges: "all",
      },
      sessions: false,
      formInteractions: true,
      fileDownloads: true,
    },
  })
}

function trackPageView() {
  amplitude.track(
    'Page View: Docs',
    {
      'url': window.href,
      'title': document.title,
      'referrer': document.referrer,
      'path': window.location.pathname
    }
  )
}

if (amplitudeKey){
  document.addEventListener("DOMContentLoaded", function() {
      init()
      setTimeout(addDeviceIdToAppLinks)
      setTimeout(trackPageView)
  });
}
</script>


  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3M31G9B0QJ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3M31G9B0QJ",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3M31G9B0QJ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    

    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="prefect.engine - Prefect Docs" />
<meta property="og:description" content="Prefect Python API for client-side execution and orchestration of flows and tasks." />
<meta property="og:image" content="https://docs.prefect.io/latest/assets/images/social/api-ref/prefect/engine.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://docs.prefect.io/latest/api-ref/prefect/engine/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter.title" content="prefect.engine - Prefect Docs" />
<meta property="twitter:description" content="Prefect Python API for client-side execution and orchestration of flows and tasks." />
<meta property="twitter:image" content="https://docs.prefect.io/latest/assets/images/social/api-ref/prefect/engine.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="#0225AC" data-md-color-accent="#0225AC">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prefect.engine" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're viewing the docs for Prefect 2.14.0.
  <a href="../../../.."> 
    <strong>Click here to view the latest docs.</strong>
  </a>

  <script type="text/javascript">
    // extract the version from the URL
    var version = window.location.pathname.split('/')[1];
    console.log("version is latest!")
    // check if the version is 'latest'
    var showVersionBanner = version !== 'latest';
    
    // hide the announcement bar if we're not showing the latest version of the docs
    // wait until dom is loaded
    document.addEventListener("DOMContentLoaded", function(event) {
      if (showVersionBanner) {
        document.querySelector('[data-md-component="announce"]').setAttribute('hidden', '');
      }
    });
  </script>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      <!-- overrides partial for header, adding tab for Prefect Cloud -->




<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Prefect Docs"
      class="md-header__button md-logo" aria-label="Prefect Docs" data-md-component="logo">
      
  <img src="../../../img/logos/prefect-logo-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Prefect Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
            prefect.engine
            
          </span>
        </div>
      </div>
    </div>
    
    
    <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="#0225AC" data-md-color-accent="#0225AC"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="#0225AC" data-md-color-accent="#0225AC"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
</form>
    
    
    
    <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    <label class="md-header__button md-icon" for="__search">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
    </label>
    <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
    <div class="md-header__source">
      <a href="https://github.com/PrefectHQ/prefect" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
    

    <!-- adding tab for Prefect Cloud -->
    <a class="md-button cloud-button list-unstyled" target="_blank" rel="noopener noreferrer" href="https://app.prefect.cloud"><b>Try Prefect
        Cloud →</b></a>
    <!-- end adding Perfect Cloud button-->

  </nav>
  
  
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Prefect Docs" class="md-nav__button md-logo" aria-label="Prefect Docs" data-md-component="logo">
      
  <img src="../../../img/logos/prefect-logo-white.svg" alt="logo">

    </a>
    Prefect Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PrefectHQ/prefect" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_1">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../tutorial/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Tutorial
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_2">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorial
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/flows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/deployments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Deploying Flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorial/workers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Workers & Work Pools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../guides/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_3">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/host/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Hosting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Profiles & Settings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/runtime-context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Runtime Context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/global-concurrency-limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Global Concurrency Limits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Variables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/using-the-client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Using the Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Execution
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Execution
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Docker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/webhooks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Webhooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/state-change-hooks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    State Change Hooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/dask-ray-task-runners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Dask & Ray
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/moving-data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Moving data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Workers and agents
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Workers and agents
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/prefect-deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Deploying flows to work pools and workers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/upgrade-guide-agents-to-workers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Upgrade from Agents to Workers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/deployment/storage-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/deployment/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/deployment/push-work-pools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Serverless Push Work Pools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="https://prefecthq.github.io/prefect-aws/#using-prefect-with-aws-ecs" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Run a flow on AWS ECS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/deployment/aci/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Azure Container Instance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/deployment/developing-a-new-worker-type/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Custom Workers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../recipes/recipes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Recipes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../concepts/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_4">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/flows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Tasks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/deployments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/work-pools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Work Pools & Workers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/schedules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Schedules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Results
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/artifacts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Artifacts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    States
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/blocks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Blocks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/task-runners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Task Runners
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Events
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/automations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Automations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_14" >
        
          <label class="md-nav__link" for="__nav_4_14" id="__nav_4_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Block and Agent-Based Deployments
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    Block and Agent-Based Deployments
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/deployments-block-based/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/infrastructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Infrastructure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/agents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../cloud/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Cloud
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_5">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cloud
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/workspaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Workspaces
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/organizations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Organizations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../cloud/users/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Users
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_5_4">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Users
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/users/roles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Roles (RBAC)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/users/api-keys/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    API Keys
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/users/service-accounts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Service Accounts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/users/sso/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Single Sign-on (SSO)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/users/audit-log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Audit Log
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/users/object-access-control-lists/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Object-Level Access Control Lists
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/rate-limits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    API Rate Limits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../cloud/connecting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Connecting & Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../integrations/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Integrations
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_6">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../integrations/usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Using Integrations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../integrations/contribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Contributing Integrations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_7">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../python/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Python SDK
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_7_2">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python SDK
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../artifacts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.artifacts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    prefect.engine
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    prefect.engine
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prefect.engine--engine-process-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Engine process overview
        </span>
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Engine process overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect.engine--flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Flows
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.engine--tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Tasks
        </span>
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.begin_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        begin_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.begin_task_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        begin_task_map()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.begin_task_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        begin_task_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.collect_task_run_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        collect_task_run_inputs()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.create_and_begin_subflow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_and_begin_subflow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.create_then_begin_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_then_begin_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.enter_flow_run_engine_from_flow_call" class="md-nav__link">
    <span class="md-ellipsis">
      
        enter_flow_run_engine_from_flow_call()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.enter_flow_run_engine_from_subprocess" class="md-nav__link">
    <span class="md-ellipsis">
      
        enter_flow_run_engine_from_subprocess()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.enter_task_run_engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        enter_task_run_engine()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.get_state_for_result" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_state_for_result()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.link_state_to_result" class="md-nav__link">
    <span class="md-ellipsis">
      
        link_state_to_result()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.orchestrate_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        orchestrate_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.orchestrate_task_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        orchestrate_task_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.pause_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        pause_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.propose_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        propose_state()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.report_flow_run_crashes" class="md-nav__link">
    <span class="md-ellipsis">
      
        report_flow_run_crashes()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.report_task_run_crashes" class="md-nav__link">
    <span class="md-ellipsis">
      
        report_task_run_crashes()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.resolve_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        resolve_inputs()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.resume_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        resume_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.retrieve_flow_then_begin_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        retrieve_flow_then_begin_flow_run()
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../filesystems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.filesystems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../flows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../futures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.futures
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../infrastructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.infrastructure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_12" >
        
          <label class="md-nav__link" for="__nav_7_2_12" id="__nav_7_2_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.deployments
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.deployments
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/deployments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    runner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/steps/core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    steps.core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/steps/pull/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    steps.pull
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/steps/utility/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    steps.utility
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.runner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_14" >
        
          <label class="md-nav__link" for="__nav_7_2_14" id="__nav_7_2_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.runtime
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_14">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.runtime
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/flow_run/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    flow_run
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/deployment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/task_run/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    task_run
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../serializers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.serializers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.settings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.states
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../task-runners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.task_runners
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    prefect.tasks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_20" >
        
          <label class="md-nav__link" for="__nav_7_2_20" id="__nav_7_2_20_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.blocks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_20_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_20">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.blocks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/notifications/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    notifications
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    system
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/webhook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    webhook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_21" >
        
          <label class="md-nav__link" for="__nav_7_2_21" id="__nav_7_2_21_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.client
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_21_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_21">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.client
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../client/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../client/cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    cloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../client/orchestration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    orchestration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../client/schemas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    schemas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../client/utilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    utilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_22" >
        
          <label class="md-nav__link" for="__nav_7_2_22" id="__nav_7_2_22_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.cli
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_22_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_22">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.cli
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    cloud
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/cloud-webhook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    cloud_webhook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/concurrency_limit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    concurrency_limit
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/dev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    dev
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/profile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    profile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/project/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    project
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/work_queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    work_queue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/root/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    root
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/deployment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/flow_run/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    flow_run
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cli/server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_23" >
        
          <label class="md-nav__link" for="__nav_7_2_23" id="__nav_7_2_23_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.utilities
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_23_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_23">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.utilities
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/annotations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    annotations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/asyncutils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    asyncutils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/processutils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    processutils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/callables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    callables
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/collections/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    collections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/filesystem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    filesystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/hashing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    hashing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_24" >
        
          <label class="md-nav__link" for="__nav_7_2_24" id="__nav_7_2_24_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    prefect.workers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_24_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_24">
            <span class="md-nav__icon md-icon"></span>
            
  
    prefect.workers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../workers/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../workers/process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../rest-api/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    REST API
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_7_3">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    REST API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="https://app.prefect.cloud/api/docs" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Prefect Cloud REST API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rest-api-reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Prefect Server REST API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../server/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Server API
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_7_4">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Server API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4_2" >
        
          <label class="md-nav__link" for="__nav_7_4_2" id="__nav_7_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/admin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.admin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/dependencies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.dependencies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/deployments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/flows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/flow_runs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.flow_runs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/flow_run_states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.flow_run_states
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/run_history/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.run_history
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/saved_searches/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.saved_searches
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/task_runs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.task_runs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/task_run_states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.api.task_run_states
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4_3" >
        
          <label class="md-nav__link" for="__nav_7_4_3" id="__nav_7_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/flows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.flows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/flow_runs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.flow_runs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/flow_run_states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.flow_run_states
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/task_runs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.task_runs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/task_run_states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.task_run_states
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/deployments/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/saved_searches/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.models.saved_searches
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4_4" >
        
          <label class="md-nav__link" for="__nav_7_4_4" id="__nav_7_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Orchestration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Orchestration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/rules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.orchestration.rules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/policies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.orchestration.policies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/core_policy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.orchestration.core_policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/global_policy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.orchestration.global_policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4_5" >
        
          <label class="md-nav__link" for="__nav_7_4_5" id="__nav_7_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Schemas
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Schemas
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/actions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.actions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/filters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.filters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.responses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/schedules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.schedules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/sorting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.sorting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/states/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.schemas.states
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4_6" >
        
          <label class="md-nav__link" for="__nav_7_4_6" id="__nav_7_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Services
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Services
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/services/late_runs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.services.late_runs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/services/loop_service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.services.loop_service
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/services/scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.services.scheduler
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4_7" >
        
          <label class="md-nav__link" for="__nav_7_4_7" id="__nav_7_4_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Utilities
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utilities
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/utilities/database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.utilities.database
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/utilities/schemas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.utilities.schemas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../server/utilities/server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    server.utilities.server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../community/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Community
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_8">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Community
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Style
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/versioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Versioning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/common-mistakes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prefect.engine--engine-process-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Engine process overview
        </span>
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Engine process overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect.engine--flows" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Flows
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.engine--tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Tasks
        </span>
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.begin_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        begin_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.begin_task_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        begin_task_map()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.begin_task_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        begin_task_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.collect_task_run_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        collect_task_run_inputs()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.create_and_begin_subflow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_and_begin_subflow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.create_then_begin_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_then_begin_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.enter_flow_run_engine_from_flow_call" class="md-nav__link">
    <span class="md-ellipsis">
      
        enter_flow_run_engine_from_flow_call()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.enter_flow_run_engine_from_subprocess" class="md-nav__link">
    <span class="md-ellipsis">
      
        enter_flow_run_engine_from_subprocess()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.enter_task_run_engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        enter_task_run_engine()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.get_state_for_result" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_state_for_result()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.link_state_to_result" class="md-nav__link">
    <span class="md-ellipsis">
      
        link_state_to_result()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.orchestrate_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        orchestrate_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.orchestrate_task_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        orchestrate_task_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.pause_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        pause_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.propose_state" class="md-nav__link">
    <span class="md-ellipsis">
      
        propose_state()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.report_flow_run_crashes" class="md-nav__link">
    <span class="md-ellipsis">
      
        report_flow_run_crashes()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.report_task_run_crashes" class="md-nav__link">
    <span class="md-ellipsis">
      
        report_task_run_crashes()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.resolve_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        resolve_inputs()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.resume_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        resume_flow_run()
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.engine.retrieve_flow_then_begin_flow_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        retrieve_flow_then_begin_flow_run()
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
    
    
      <li class="md-path__item">
        <a href="../../" class="md-path__link">
          
  <span class="md-ellipsis">
    API Reference
  </span>

        </a>
      </li>
    
  

      
        
  
    
    
      <li class="md-path__item">
        <a href="../../python/" class="md-path__link">
          
  <span class="md-ellipsis">
    Python SDK
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/PrefectHQ/prefect/edit/main/docs/api-ref/prefect/engine.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  


<div class="doc doc-object doc-module">




<h1 id="prefect.engine" class="doc doc-heading">
          <code>prefect.engine</code>


<a href="#prefect.engine" class="headerlink" title="Permanent link">&para;</a></h1>

  <div class="doc doc-contents first">
  
      <p>Client-side execution and orchestration of flows and tasks.</p>
<h3 id="prefect.engine--engine-process-overview">Engine process overview<a class="headerlink" href="#prefect.engine--engine-process-overview" title="Permanent link">&para;</a></h3>
<h4 id="prefect.engine--flows">Flows<a class="headerlink" href="#prefect.engine--flows" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><strong>The flow is called by the user or an existing flow run is executed in a new process.</strong></p>
<p>See <code>Flow.__call__</code> and <code>prefect.engine.__main__</code> (<code>python -m prefect.engine</code>)</p>
</li>
<li>
<p><strong>A synchronous function acts as an entrypoint to the engine.</strong>
    The engine executes on a dedicated "global loop" thread. For asynchronous flow calls,
    we return a coroutine from the entrypoint so the user can enter the engine without
    blocking their event loop.</p>
<p>See <code>enter_flow_run_engine_from_flow_call</code>, <code>enter_flow_run_engine_from_subprocess</code></p>
</li>
<li>
<p><strong>The thread that calls the entrypoint waits until orchestration of the flow run completes.</strong>
    This thread is referred to as the "user" thread and is usually the "main" thread.
    The thread is not blocked while waiting — it allows the engine to send work back to it.
    This allows us to send calls back to the user thread from the global loop thread.</p>
<p>See <code>wait_for_call_in_loop_thread</code> and <code>call_soon_in_waiting_thread</code></p>
</li>
<li>
<p><strong>The asynchronous engine branches depending on if the flow run exists already and if
    there is a parent flow run in the current context.</strong></p>
<p>See <code>create_then_begin_flow_run</code>, <code>create_and_begin_subflow_run</code>, and <code>retrieve_flow_then_begin_flow_run</code></p>
</li>
<li>
<p><strong>The asynchronous engine prepares for execution of the flow run.</strong>
    This includes starting the task runner, preparing context, etc.</p>
<p>See <code>begin_flow_run</code></p>
</li>
<li>
<p><strong>The flow run is orchestrated through states, calling the user's function as necessary.</strong>
    Generally the user's function is sent for execution on the user thread.
    If the flow function cannot be safely executed on the user thread, e.g. it is
    a synchronous child in an asynchronous parent it will be scheduled on a worker
    thread instead.</p>
<p>See <code>orchestrate_flow_run</code>, <code>call_soon_in_waiting_thread</code>, <code>call_soon_in_new_thread</code></p>
</li>
</ul>
<h4 id="prefect.engine--tasks">Tasks<a class="headerlink" href="#prefect.engine--tasks" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><strong>The task is called or submitted by the user.</strong>
    We require that this is always within a flow.</p>
<p>See <code>Task.__call__</code> and <code>Task.submit</code></p>
</li>
<li>
<p><strong>A synchronous function acts as an entrypoint to the engine.</strong>
    Unlike flow calls, this <em>will not</em> block until completion if <code>submit</code> was used.</p>
<p>See <code>enter_task_run_engine</code></p>
</li>
<li>
<p><strong>A future is created for the task call.</strong>
    Creation of the task run and submission to the task runner is scheduled as a
    background task so submission of many tasks can occur concurrently.</p>
<p>See <code>create_task_run_future</code> and <code>create_task_run_then_submit</code></p>
</li>
<li>
<p><strong>The engine branches depending on if a future, state, or result is requested.</strong>
    If a future is requested, it is returned immediately to the user thread.
    Otherwise, the engine will wait for the task run to complete and return the final
    state or result.</p>
<p>See <code>get_task_call_return_value</code></p>
</li>
<li>
<p><strong>An engine function is submitted to the task runner.</strong>
    The task runner will schedule this function for execution on a worker.
    When executed, it will prepare for orchestration and wait for completion of the run.</p>
<p>See <code>create_task_run_then_submit</code> and <code>begin_task_run</code></p>
</li>
<li>
<p><strong>The task run is orchestrated through states, calling the user's function as necessary.</strong>
    The user's function is always executed in a worker thread for isolation.</p>
<p>See <code>orchestrate_task_run</code>, <code>call_soon_in_new_thread</code></p>
<p>_Ideally, for local and sequential task runners we would send the task run to the
user thread as we do for flows. See <a href="https://github.com/PrefectHQ/prefect/pull/9855">#9855</a>.</p>
</li>
</ul>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="prefect.engine.begin_flow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">begin_flow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.begin_flow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Begins execution of a flow run; blocks until completion of the flow run</p>
<ul>
<li>Starts a task runner</li>
<li>Determines the result storage block to use</li>
<li>Orchestrates the flow run (runs the user-function and generates tasks)</li>
<li>Waits for tasks to complete / shutsdown the task runner</li>
<li>Sets a terminal state for the flow run</li>
</ul>
<p>Note that the <code>flow_run</code> contains a <code>parameters</code> attribute which is the serialized
parameters sent to the backend while the <code>parameters</code> argument here should be the
deserialized and validated dictionary of python objects.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.states.State" href="../client/schemas/#prefect.client.schemas.objects.State">State</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The final state of the run</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">begin_flow_run</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">,</span>
    <span class="n">flow_run</span><span class="p">:</span> <span class="n">FlowRun</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
    <span class="n">user_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Begins execution of a flow run; blocks until completion of the flow run</span>

<span class="sd">    - Starts a task runner</span>
<span class="sd">    - Determines the result storage block to use</span>
<span class="sd">    - Orchestrates the flow run (runs the user-function and generates tasks)</span>
<span class="sd">    - Waits for tasks to complete / shutsdown the task runner</span>
<span class="sd">    - Sets a terminal state for the flow run</span>

<span class="sd">    Note that the `flow_run` contains a `parameters` attribute which is the serialized</span>
<span class="sd">    parameters sent to the backend while the `parameters` argument here should be the</span>
<span class="sd">    deserialized and validated dictionary of python objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The final state of the run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>

    <span class="n">log_prints</span> <span class="o">=</span> <span class="n">should_log_prints</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
    <span class="n">flow_run_context</span> <span class="o">=</span> <span class="n">PartialModel</span><span class="p">(</span><span class="n">FlowRunContext</span><span class="p">,</span> <span class="n">log_prints</span><span class="o">=</span><span class="n">log_prints</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span>
            <span class="n">report_flow_run_crashes</span><span class="p">(</span><span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create a task group for background tasks</span>
        <span class="n">flow_run_context</span><span class="o">.</span><span class="n">background_tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span>
            <span class="n">anyio</span><span class="o">.</span><span class="n">create_task_group</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># If the flow is async, we need to provide a portal so sync tasks can run</span>
        <span class="n">flow_run_context</span><span class="o">.</span><span class="n">sync_portal</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">start_blocking_portal</span><span class="p">())</span> <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">isasync</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">task_runner</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">task_runner</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">task_runner</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="c1"># Backwards compatibility; will not support concurrent flow runs</span>
            <span class="n">task_runner</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">task_runner</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Task runner </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task_runner</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> does not implement the&quot;</span>
                <span class="s2">&quot; `duplicate` method and will fail if used for concurrent execution of&quot;</span>
                <span class="s2">&quot; the same flow.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">task_runner</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2">; submitted tasks &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;will be run </span><span class="si">{</span><span class="n">CONCURRENCY_MESSAGES</span><span class="p">[</span><span class="n">flow</span><span class="o">.</span><span class="n">task_runner</span><span class="o">.</span><span class="n">concurrency_type</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
        <span class="p">)</span>

        <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_runner</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span>
            <span class="n">task_runner</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">flow_run_context</span><span class="o">.</span><span class="n">result_factory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ResultFactory</span><span class="o">.</span><span class="n">from_flow</span><span class="p">(</span>
            <span class="n">flow</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_prints</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">patch_print</span><span class="p">())</span>

        <span class="n">terminal_or_paused_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orchestrate_flow_run</span><span class="p">(</span>
            <span class="n">flow</span><span class="p">,</span>
            <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">wait_for</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">partial_flow_run_context</span><span class="o">=</span><span class="n">flow_run_context</span><span class="p">,</span>
            <span class="c1"># Orchestration needs to be interruptible if it has a timeout</span>
            <span class="n">interruptible</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">timeout_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">user_thread</span><span class="o">=</span><span class="n">user_thread</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">terminal_or_paused_state</span><span class="o">.</span><span class="n">is_paused</span><span class="p">():</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">terminal_or_paused_state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">pause_timeout</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Currently paused and suspending execution.&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; Resume before </span><span class="si">{</span><span class="n">timeout</span><span class="o">.</span><span class="n">to_rfc3339_string</span><span class="p">()</span><span class="si">}</span><span class="s2"> to finish execution.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">APILogHandler</span><span class="o">.</span><span class="n">aflush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">terminal_or_paused_state</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">terminal_state</span> <span class="o">=</span> <span class="n">terminal_or_paused_state</span>

    <span class="c1"># If debugging, use the more complete `repr` than the usual `str` description</span>
    <span class="n">display_state</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">terminal_state</span><span class="p">)</span> <span class="k">if</span> <span class="n">PREFECT_DEBUG_MODE</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">terminal_state</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">is_completed</span><span class="p">()</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Finished in state </span><span class="si">{</span><span class="n">display_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># When a &quot;root&quot; flow run finishes, flush logs so we do not have to rely on handling</span>
    <span class="c1"># during interpreter shutdown</span>
    <span class="k">await</span> <span class="n">APILogHandler</span><span class="o">.</span><span class="n">aflush</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">terminal_state</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.begin_task_map" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">begin_task_map</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.begin_task_map" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Async entrypoint for task mapping</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">begin_task_map</span><span class="p">(</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
    <span class="n">flow_run_context</span><span class="p">:</span> <span class="n">FlowRunContext</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">return_type</span><span class="p">:</span> <span class="n">EngineReturnType</span><span class="p">,</span>
    <span class="n">task_runner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseTaskRunner</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Async entrypoint for task mapping&quot;&quot;&quot;</span>
    <span class="c1"># We need to resolve some futures to map over their data, collect the upstream</span>
    <span class="c1"># links beforehand to retain relationship tracking.</span>
    <span class="n">task_inputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="k">await</span> <span class="n">collect_task_run_inputs</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1"># Resolve the top-level parameters in order to get mappable data of a known length.</span>
    <span class="c1"># Nested parameters will be resolved in each mapped child where their relationships</span>
    <span class="c1"># will also be tracked.</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resolve_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Ensure that any parameters in kwargs are expanded before this check</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">explode_variadic_parameter</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="n">iterable_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">static_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">annotated_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">allow_failure</span><span class="p">,</span> <span class="n">quote</span><span class="p">)):</span>
            <span class="c1"># Unwrap annotated parameters to determine if they are iterable</span>
            <span class="n">annotated_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unmapped</span><span class="p">):</span>
            <span class="n">static_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">isiterable</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">iterable_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">static_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable_parameters</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MappingMissingIterable</span><span class="p">(</span>
            <span class="s2">&quot;No iterable parameters were received. Parameters for map must &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;include at least one iterable. Parameters: </span><span class="si">{</span><span class="n">parameters</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">iterable_parameter_lengths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iterable_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">iterable_parameter_lengths</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MappingLengthMismatch</span><span class="p">(</span>
            <span class="s2">&quot;Received iterable parameters with different lengths. Parameters for map&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; must all be the same length. Got lengths: </span><span class="si">{</span><span class="n">iterable_parameter_lengths</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">map_length</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lengths</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">task_runs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">map_length</span><span class="p">):</span>
        <span class="n">call_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">call_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">static_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="c1"># Add default values for parameters; these are skipped earlier since they should</span>
        <span class="c1"># not be mapped over</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">get_parameter_defaults</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">call_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Re-apply annotations to each key again</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotated_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">call_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">rewrap</span><span class="p">(</span><span class="n">call_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c1"># Collapse any previously exploded kwargs</span>
        <span class="n">call_parameters</span> <span class="o">=</span> <span class="n">collapse_variadic_parameters</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">call_parameters</span><span class="p">)</span>

        <span class="n">task_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span>
                <span class="n">get_task_call_return_value</span><span class="p">,</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">flow_run_context</span><span class="o">=</span><span class="n">flow_run_context</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">call_parameters</span><span class="p">,</span>
                <span class="n">wait_for</span><span class="o">=</span><span class="n">wait_for</span><span class="p">,</span>
                <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
                <span class="n">task_runner</span><span class="o">=</span><span class="n">task_runner</span><span class="p">,</span>
                <span class="n">extra_task_inputs</span><span class="o">=</span><span class="n">task_inputs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Maintain the order of the task runs when using the sequential task runner</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">task_runner</span> <span class="k">if</span> <span class="n">task_runner</span> <span class="k">else</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_runner</span>
    <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">concurrency_type</span> <span class="o">==</span> <span class="n">TaskConcurrencyType</span><span class="o">.</span><span class="n">SEQUENTIAL</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="k">await</span> <span class="n">task_run</span><span class="p">()</span> <span class="k">for</span> <span class="n">task_run</span> <span class="ow">in</span> <span class="n">task_runs</span><span class="p">]</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">task_runs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.begin_task_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">begin_task_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.begin_task_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Entrypoint for task run execution.</p>
<p>This function is intended for submission to the task runner.</p>
<p>This method may be called from a worker so we ensure the settings context has been
entered. For example, with a runner that is executing tasks in the same event loop,
we will likely not enter the context again because the current context already
matches:</p>
<p>main thread:
--&gt; Flow called with settings A
--&gt; <code>begin_task_run</code> executes same event loop
--&gt; Profile A matches and is not entered again</p>
<p>However, with execution on a remote environment, we are going to need to ensure the
settings for the task run are respected by entering the context:</p>
<p>main thread:
--&gt; Flow called with settings A
--&gt; <code>begin_task_run</code> is scheduled on a remote worker, settings A is serialized
remote worker:
--&gt; Remote worker imports Prefect (may not occur)
--&gt; Global settings is loaded with default settings
--&gt; <code>begin_task_run</code> executes on a different event loop than the flow
--&gt; Current settings is not set or does not match, settings A is entered</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">begin_task_run</span><span class="p">(</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
    <span class="n">task_run</span><span class="p">:</span> <span class="n">TaskRun</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">result_factory</span><span class="p">:</span> <span class="n">ResultFactory</span><span class="p">,</span>
    <span class="n">log_prints</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">SettingsContext</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entrypoint for task run execution.</span>

<span class="sd">    This function is intended for submission to the task runner.</span>

<span class="sd">    This method may be called from a worker so we ensure the settings context has been</span>
<span class="sd">    entered. For example, with a runner that is executing tasks in the same event loop,</span>
<span class="sd">    we will likely not enter the context again because the current context already</span>
<span class="sd">    matches:</span>

<span class="sd">    main thread:</span>
<span class="sd">    --&gt; Flow called with settings A</span>
<span class="sd">    --&gt; `begin_task_run` executes same event loop</span>
<span class="sd">    --&gt; Profile A matches and is not entered again</span>

<span class="sd">    However, with execution on a remote environment, we are going to need to ensure the</span>
<span class="sd">    settings for the task run are respected by entering the context:</span>

<span class="sd">    main thread:</span>
<span class="sd">    --&gt; Flow called with settings A</span>
<span class="sd">    --&gt; `begin_task_run` is scheduled on a remote worker, settings A is serialized</span>
<span class="sd">    remote worker:</span>
<span class="sd">    --&gt; Remote worker imports Prefect (may not occur)</span>
<span class="sd">    --&gt; Global settings is loaded with default settings</span>
<span class="sd">    --&gt; `begin_task_run` executes on a different event loop than the flow</span>
<span class="sd">    --&gt; Current settings is not set or does not match, settings A is entered</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maybe_flow_run_context</span> <span class="o">=</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
        <span class="c1"># The settings context may be null on a remote worker so we use the safe `.get`</span>
        <span class="c1"># method and compare it to the settings required for this task run</span>
        <span class="k">if</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">SettingsContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">!=</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">setup_logging</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">maybe_flow_run_context</span><span class="p">:</span>
            <span class="c1"># Accessible if on a worker that is running in the same thread as the flow</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">maybe_flow_run_context</span><span class="o">.</span><span class="n">client</span>
            <span class="c1"># Only run the task in an interruptible thread if it in the same thread as</span>
            <span class="c1"># the flow _and_ the flow run has a timeout attached. If the task is on a</span>
            <span class="c1"># worker, the flow run timeout will not be raised in the worker process.</span>
            <span class="n">interruptible</span> <span class="o">=</span> <span class="n">maybe_flow_run_context</span><span class="o">.</span><span class="n">timeout_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, retrieve a new client</span>
            <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">interruptible</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span><span class="n">anyio</span><span class="o">.</span><span class="n">create_task_group</span><span class="p">())</span>

        <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span><span class="n">report_task_run_crashes</span><span class="p">(</span><span class="n">task_run</span><span class="p">,</span> <span class="n">client</span><span class="p">))</span>

        <span class="c1"># TODO: Use the background tasks group to manage logging for this task</span>

        <span class="k">if</span> <span class="n">log_prints</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">patch_print</span><span class="p">())</span>

        <span class="k">await</span> <span class="n">check_api_reachable</span><span class="p">(</span>
            <span class="n">client</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Cannot orchestrate task run &#39;</span><span class="si">{</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orchestrate_task_run</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
                <span class="n">wait_for</span><span class="o">=</span><span class="n">wait_for</span><span class="p">,</span>
                <span class="n">result_factory</span><span class="o">=</span><span class="n">result_factory</span><span class="p">,</span>
                <span class="n">log_prints</span><span class="o">=</span><span class="n">log_prints</span><span class="p">,</span>
                <span class="n">interruptible</span><span class="o">=</span><span class="n">interruptible</span><span class="p">,</span>
                <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">maybe_flow_run_context</span><span class="p">:</span>
                <span class="c1"># When a a task run finishes on a remote worker flush logs to prevent</span>
                <span class="c1"># loss if the process exits</span>
                <span class="k">await</span> <span class="n">APILogHandler</span><span class="o">.</span><span class="n">aflush</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">Abort</span> <span class="k">as</span> <span class="n">abort</span><span class="p">:</span>
            <span class="c1"># Task run probably already completed, fetch its state</span>
            <span class="n">task_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_task_run</span><span class="p">(</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">task_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_final</span><span class="p">():</span>
                <span class="n">task_run_logger</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Task run &#39;</span><span class="si">{</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; already finished.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: This is a concerning case; we should determine when this occurs</span>
                <span class="c1">#       1. This can occur when the flow run is not in a running state</span>
                <span class="n">task_run_logger</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Task run &#39;</span><span class="si">{</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; received abort during orchestration: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abort</span><span class="si">}</span><span class="s2"> Task run is in </span><span class="si">{</span><span class="n">task_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> state.&quot;</span>
                <span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">task_run</span><span class="o">.</span><span class="n">state</span>

        <span class="k">except</span> <span class="n">Pause</span><span class="p">:</span>
            <span class="n">task_run_logger</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Task run encountered a pause signal during orchestration.&quot;</span>
            <span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">Paused</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.collect_task_run_inputs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">collect_task_run_inputs</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.collect_task_run_inputs" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>This function recurses through an expression to generate a set of any discernible
task run inputs it finds in the data structure. It produces a set of all inputs
found.</p>



<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">task_inputs</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="n">k</span><span class="p">:</span> <span class="k">await</span> <span class="n">collect_task_run_inputs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">}</span>
</code></pre></div>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">collect_task_run_inputs</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">TaskRunInput</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function recurses through an expression to generate a set of any discernible</span>
<span class="sd">    task run inputs it finds in the data structure. It produces a set of all inputs</span>
<span class="sd">    found.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; task_inputs = {</span>
<span class="sd">        &gt;&gt;&gt;    k: await collect_task_run_inputs(v) for k, v in parameters.items()</span>
<span class="sd">        &gt;&gt;&gt; }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: This function needs to be updated to detect parameters and constants</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_futures_and_states_to_inputs</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">PrefectFuture</span><span class="p">):</span>
            <span class="c1"># We need to wait for futures to be submitted before we can get the task</span>
            <span class="c1"># run id but we want to do so asynchronously</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_state</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">task_run_id</span><span class="p">:</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TaskRunResult</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">task_run_id</span><span class="p">))</span>
        <span class="c1"># Expressions inside quotes should not be traversed</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">quote</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StopVisiting</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">get_state_for_result</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">task_run_id</span><span class="p">:</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TaskRunResult</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">task_run_id</span><span class="p">))</span>

    <span class="n">visit_collection</span><span class="p">(</span>
        <span class="n">expr</span><span class="p">,</span>
        <span class="n">visit_fn</span><span class="o">=</span><span class="n">add_futures_and_states_to_inputs</span><span class="p">,</span>
        <span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">_wait_for_submission</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TaskRunResult</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">future</span><span class="o">.</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">inputs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.create_and_begin_subflow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_and_begin_subflow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.create_and_begin_subflow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Async entrypoint for flows calls within a flow run</p>
<p>Subflows differ from parent flows in that they
- Resolve futures in passed parameters into values
- Create a dummy task for representation in the parent flow
- Retrieve default result storage from the parent flow rather than the server</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The final state of the run</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@inject_client</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_and_begin_subflow_run</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">return_type</span><span class="p">:</span> <span class="n">EngineReturnType</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
    <span class="n">user_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Async entrypoint for flows calls within a flow run</span>

<span class="sd">    Subflows differ from parent flows in that they</span>
<span class="sd">    - Resolve futures in passed parameters into values</span>
<span class="sd">    - Create a dummy task for representation in the parent flow</span>
<span class="sd">    - Retrieve default result storage from the parent flow rather than the server</span>

<span class="sd">    Returns:</span>
<span class="sd">        The final state of the run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parent_flow_run_context</span> <span class="o">=</span> <span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">parent_logger</span> <span class="o">=</span> <span class="n">get_run_logger</span><span class="p">(</span><span class="n">parent_flow_run_context</span><span class="p">)</span>
    <span class="n">log_prints</span> <span class="o">=</span> <span class="n">should_log_prints</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
    <span class="n">terminal_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">parent_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolving inputs to </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">task_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="k">await</span> <span class="n">collect_task_run_inputs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">wait_for</span><span class="p">:</span>
        <span class="n">task_inputs</span><span class="p">[</span><span class="s2">&quot;wait_for&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">collect_task_run_inputs</span><span class="p">(</span><span class="n">wait_for</span><span class="p">)</span>

    <span class="n">rerunning</span> <span class="o">=</span> <span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">flow_run</span><span class="o">.</span><span class="n">run_count</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="c1"># Generate a task in the parent flow run to represent the result of the subflow run</span>
    <span class="n">dummy_task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
    <span class="n">parent_task_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">create_task_run</span><span class="p">(</span>
        <span class="n">task</span><span class="o">=</span><span class="n">dummy_task</span><span class="p">,</span>
        <span class="n">flow_run_id</span><span class="o">=</span><span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">dynamic_key</span><span class="o">=</span><span class="n">_dynamic_key_for_task_run</span><span class="p">(</span><span class="n">parent_flow_run_context</span><span class="p">,</span> <span class="n">dummy_task</span><span class="p">),</span>
        <span class="n">task_inputs</span><span class="o">=</span><span class="n">task_inputs</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="n">Pending</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># Resolve any task futures in the input</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resolve_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parent_task_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_final</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rerunning</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent_task_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_completed</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="c1"># Retrieve the most recent flow run from the database</span>
        <span class="n">flow_runs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_flow_runs</span><span class="p">(</span>
            <span class="n">flow_run_filter</span><span class="o">=</span><span class="n">FlowRunFilter</span><span class="p">(</span>
                <span class="n">parent_task_run_id</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;any_&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">parent_task_run</span><span class="o">.</span><span class="n">id</span><span class="p">]}</span>
            <span class="p">),</span>
            <span class="n">sort</span><span class="o">=</span><span class="n">FlowRunSort</span><span class="o">.</span><span class="n">EXPECTED_START_TIME_ASC</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">flow_run</span> <span class="o">=</span> <span class="n">flow_runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Set up variables required downstream</span>
        <span class="n">terminal_state</span> <span class="o">=</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">state</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">create_flow_run</span><span class="p">(</span>
            <span class="n">flow</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">serialize_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">),</span>
            <span class="n">parent_task_run_id</span><span class="o">=</span><span class="n">parent_task_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">parent_task_run</span><span class="o">.</span><span class="n">state</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rerunning</span> <span class="k">else</span> <span class="n">Pending</span><span class="p">(),</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">TagsContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">current_tags</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parent_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Created subflow run </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> for flow </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
        <span class="n">ui_url</span> <span class="o">=</span> <span class="n">PREFECT_UI_URL</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ui_url</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;View at </span><span class="si">{</span><span class="n">ui_url</span><span class="si">}</span><span class="s2">/flow-runs/flow-run/</span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;send_to_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="n">result_factory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ResultFactory</span><span class="o">.</span><span class="n">from_flow</span><span class="p">(</span>
            <span class="n">flow</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">client</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">should_validate_parameters</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">validate_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Validation of flow parameters failed with error:&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">=</span><span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">result_factory</span><span class="o">=</span><span class="n">result_factory</span>
                    <span class="p">),</span>
                    <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">terminal_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">is_final</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span>
                    <span class="n">report_flow_run_crashes</span><span class="p">(</span><span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">task_runner</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">task_runner</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">task_runner</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
                    <span class="c1"># Backwards compatibility; will not support concurrent flow runs</span>
                    <span class="n">task_runner</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">task_runner</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Task runner </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task_runner</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> does not implement&quot;</span>
                        <span class="s2">&quot; the `duplicate` method and will fail if used for concurrent&quot;</span>
                        <span class="s2">&quot; execution of the same flow.&quot;</span>
                    <span class="p">)</span>

                <span class="k">await</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span><span class="n">task_runner</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">log_prints</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">patch_print</span><span class="p">())</span>

                <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">orchestrate_flow_run</span><span class="p">(</span>
                    <span class="n">flow</span><span class="p">,</span>
                    <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
                    <span class="n">wait_for</span><span class="o">=</span><span class="n">wait_for</span><span class="p">,</span>
                    <span class="c1"># If the parent flow run has a timeout, then this one needs to be</span>
                    <span class="c1"># interruptible as well</span>
                    <span class="n">interruptible</span><span class="o">=</span><span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">timeout_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                    <span class="n">partial_flow_run_context</span><span class="o">=</span><span class="n">PartialModel</span><span class="p">(</span>
                        <span class="n">FlowRunContext</span><span class="p">,</span>
                        <span class="n">sync_portal</span><span class="o">=</span><span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">sync_portal</span><span class="p">,</span>
                        <span class="n">task_runner</span><span class="o">=</span><span class="n">task_runner</span><span class="p">,</span>
                        <span class="n">background_tasks</span><span class="o">=</span><span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">background_tasks</span><span class="p">,</span>
                        <span class="n">result_factory</span><span class="o">=</span><span class="n">result_factory</span><span class="p">,</span>
                        <span class="n">log_prints</span><span class="o">=</span><span class="n">log_prints</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">user_thread</span><span class="o">=</span><span class="n">user_thread</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># Display the full state (including the result) if debugging</span>
    <span class="n">display_state</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">terminal_state</span><span class="p">)</span> <span class="k">if</span> <span class="n">PREFECT_DEBUG_MODE</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">terminal_state</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">is_completed</span><span class="p">()</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Finished in state </span><span class="si">{</span><span class="n">display_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Track the subflow state so the parent flow can use it to determine its final state</span>
    <span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">flow_run_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terminal_state</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">terminal_state</span>
    <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">fetch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid return type for flow engine </span><span class="si">{</span><span class="n">return_type</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.create_then_begin_flow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_then_begin_flow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.create_then_begin_flow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Async entrypoint for flow calls</p>
<p>Creates the flow run in the backend, then enters the main flow run engine.</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@inject_client</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_then_begin_flow_run</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">return_type</span><span class="p">:</span> <span class="n">EngineReturnType</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
    <span class="n">user_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Async entrypoint for flow calls</span>

<span class="sd">    Creates the flow run in the backend, then enters the main flow run engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Returns a `State` depending on `return_type` and we can add an overload to</span>
    <span class="c1">#       the function signature to clarify this eventually.</span>

    <span class="k">await</span> <span class="n">check_api_reachable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&quot;Cannot create flow run&quot;</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">Pending</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">should_validate_parameters</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">validate_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Validation of flow parameters failed with error:&quot;</span>
            <span class="p">)</span>

    <span class="n">flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">create_flow_run</span><span class="p">(</span>
        <span class="n">flow</span><span class="p">,</span>
        <span class="c1"># Send serialized parameters to the backend</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">serialize_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">),</span>
        <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">TagsContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">current_tags</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">engine_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created flow run </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> for flow </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>

    <span class="n">ui_url</span> <span class="o">=</span> <span class="n">PREFECT_UI_URL</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ui_url</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;View at </span><span class="si">{</span><span class="n">ui_url</span><span class="si">}</span><span class="s2">/flow-runs/flow-run/</span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;send_to_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_failed</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="n">engine_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Flow run </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> received invalid parameters and is marked as&quot;</span>
            <span class="s2">&quot; failed.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">begin_flow_run</span><span class="p">(</span>
            <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
            <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">user_thread</span><span class="o">=</span><span class="n">user_thread</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state</span>
    <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">fetch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid return type for flow engine </span><span class="si">{</span><span class="n">return_type</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.enter_flow_run_engine_from_flow_call" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">enter_flow_run_engine_from_flow_call</span></code>

<a href="#prefect.engine.enter_flow_run_engine_from_flow_call" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Sync entrypoint for flow calls.</p>
<p>This function does the heavy lifting of ensuring we can get into an async context
for flow run execution with minimal overhead.</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">enter_flow_run_engine_from_flow_call</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">return_type</span><span class="p">:</span> <span class="n">EngineReturnType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sync entrypoint for flow calls.</span>

<span class="sd">    This function does the heavy lifting of ensuring we can get into an async context</span>
<span class="sd">    for flow run execution with minimal overhead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setup_logging</span><span class="p">()</span>

    <span class="n">registry</span> <span class="o">=</span> <span class="n">PrefectObjectRegistry</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">registry</span> <span class="ow">and</span> <span class="n">registry</span><span class="o">.</span><span class="n">block_code_execution</span><span class="p">:</span>
        <span class="n">engine_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Script loading is in progress, flow </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> will not be executed.&quot;</span>
            <span class="s2">&quot; Consider updating the script to only call the flow if executed&quot;</span>
            <span class="sa">f</span><span class="s1">&#39; directly:</span><span class="se">\n\n\t</span><span class="s1">if __name__ == &quot;__main__&quot;:</span><span class="se">\n\t\t</span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">()&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">TaskRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Flows cannot be run from within tasks. Did you mean to call this &quot;</span>
            <span class="s2">&quot;flow in a flow?&quot;</span>
        <span class="p">)</span>

    <span class="n">parent_flow_run_context</span> <span class="o">=</span> <span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">is_subflow_run</span> <span class="o">=</span> <span class="n">parent_flow_run_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">wait_for</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_subflow_run</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only flows run as subflows can wait for dependencies.&quot;</span><span class="p">)</span>

    <span class="n">begin_run</span> <span class="o">=</span> <span class="n">create_call</span><span class="p">(</span>
        <span class="n">create_and_begin_subflow_run</span> <span class="k">if</span> <span class="n">is_subflow_run</span> <span class="k">else</span> <span class="n">create_then_begin_flow_run</span><span class="p">,</span>
        <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">wait_for</span><span class="o">=</span><span class="n">wait_for</span><span class="p">,</span>
        <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">client</span> <span class="k">if</span> <span class="n">is_subflow_run</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_thread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># On completion of root flows, wait for the global thread to ensure that</span>
    <span class="c1"># any work there is complete</span>
    <span class="n">done_callbacks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">create_call</span><span class="p">(</span><span class="n">wait_for_global_loop_exit</span><span class="p">)]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_subflow_run</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1"># WARNING: You must define any context managers here to pass to our concurrency</span>
    <span class="c1"># api instead of entering them in here in the engine entrypoint. Otherwise, async</span>
    <span class="c1"># flows will not use the context as this function _exits_ to return an awaitable to</span>
    <span class="c1"># the user. Generally, you should enter contexts _within_ the async `begin_run`</span>
    <span class="c1"># instead but if you need to enter a context from the main thread you&#39;ll need to do</span>
    <span class="c1"># it here.</span>
    <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">capture_sigterm</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">isasync</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">is_subflow_run</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_subflow_run</span> <span class="ow">and</span> <span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">isasync</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="c1"># return a coro for the user to await if the flow is async</span>
        <span class="c1"># unless it is an async subflow called in a sync flow</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">from_async</span><span class="o">.</span><span class="n">wait_for_call_in_loop_thread</span><span class="p">(</span>
            <span class="n">begin_run</span><span class="p">,</span>
            <span class="n">done_callbacks</span><span class="o">=</span><span class="n">done_callbacks</span><span class="p">,</span>
            <span class="n">contexts</span><span class="o">=</span><span class="n">contexts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">from_sync</span><span class="o">.</span><span class="n">wait_for_call_in_loop_thread</span><span class="p">(</span>
            <span class="n">begin_run</span><span class="p">,</span>
            <span class="n">done_callbacks</span><span class="o">=</span><span class="n">done_callbacks</span><span class="p">,</span>
            <span class="n">contexts</span><span class="o">=</span><span class="n">contexts</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">retval</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.enter_flow_run_engine_from_subprocess" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">enter_flow_run_engine_from_subprocess</span></code>

<a href="#prefect.engine.enter_flow_run_engine_from_subprocess" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Sync entrypoint for flow runs that have been submitted for execution by an agent</p>
<p>Differs from <code>enter_flow_run_engine_from_flow_call</code> in that we have a flow run id
but not a flow object. The flow must be retrieved before execution can begin.
Additionally, this assumes that the caller is always in a context without an event
loop as this should be called from a fresh process.</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">enter_flow_run_engine_from_subprocess</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sync entrypoint for flow runs that have been submitted for execution by an agent</span>

<span class="sd">    Differs from `enter_flow_run_engine_from_flow_call` in that we have a flow run id</span>
<span class="sd">    but not a flow object. The flow must be retrieved before execution can begin.</span>
<span class="sd">    Additionally, this assumes that the caller is always in a context without an event</span>
<span class="sd">    loop as this should be called from a fresh process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Ensure collections are imported and have the opportunity to register types before</span>
    <span class="c1"># loading the user code from the deployment</span>
    <span class="n">prefect</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">load_prefect_collections</span><span class="p">()</span>

    <span class="n">setup_logging</span><span class="p">()</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">from_sync</span><span class="o">.</span><span class="n">wait_for_call_in_loop_thread</span><span class="p">(</span>
        <span class="n">create_call</span><span class="p">(</span>
            <span class="n">retrieve_flow_then_begin_flow_run</span><span class="p">,</span>
            <span class="n">flow_run_id</span><span class="p">,</span>
            <span class="n">user_thread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">(),</span>
        <span class="p">),</span>
        <span class="n">contexts</span><span class="o">=</span><span class="p">[</span><span class="n">capture_sigterm</span><span class="p">()],</span>
    <span class="p">)</span>

    <span class="n">APILogHandler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.enter_task_run_engine" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">enter_task_run_engine</span></code>

<a href="#prefect.engine.enter_task_run_engine" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Sync entrypoint for task calls</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">enter_task_run_engine</span><span class="p">(</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">return_type</span><span class="p">:</span> <span class="n">EngineReturnType</span><span class="p">,</span>
    <span class="n">task_runner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseTaskRunner</span><span class="p">],</span>
    <span class="n">mapped</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sync entrypoint for task calls</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">flow_run_context</span> <span class="o">=</span> <span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_run_context</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Tasks cannot be run outside of a flow. To call the underlying task&quot;</span>
            <span class="s2">&quot; function outside of a flow use `task.fn()`.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">TaskRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Tasks cannot be run from within tasks. Did you mean to call this &quot;</span>
            <span class="s2">&quot;task in a flow?&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">timeout_scope</span> <span class="ow">and</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">timeout_scope</span><span class="o">.</span><span class="n">cancel_called</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Flow run timed out&quot;</span><span class="p">)</span>

    <span class="n">begin_run</span> <span class="o">=</span> <span class="n">create_call</span><span class="p">(</span>
        <span class="n">begin_task_map</span> <span class="k">if</span> <span class="n">mapped</span> <span class="k">else</span> <span class="n">get_task_call_return_value</span><span class="p">,</span>
        <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
        <span class="n">flow_run_context</span><span class="o">=</span><span class="n">flow_run_context</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">wait_for</span><span class="o">=</span><span class="n">wait_for</span><span class="p">,</span>
        <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
        <span class="n">task_runner</span><span class="o">=</span><span class="n">task_runner</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">isasync</span> <span class="ow">and</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">isasync</span><span class="p">:</span>
        <span class="c1"># return a coro for the user to await if an async task in an async flow</span>
        <span class="k">return</span> <span class="n">from_async</span><span class="o">.</span><span class="n">wait_for_call_in_loop_thread</span><span class="p">(</span><span class="n">begin_run</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">from_sync</span><span class="o">.</span><span class="n">wait_for_call_in_loop_thread</span><span class="p">(</span><span class="n">begin_run</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.get_state_for_result" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_state_for_result</span></code>

<a href="#prefect.engine.get_state_for_result" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Get the state related to a result object.</p>
<p><code>link_state_to_result</code> must have been called first.</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_state_for_result</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">State</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the state related to a result object.</span>

<span class="sd">    `link_state_to_result` must have been called first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow_run_context</span> <span class="o">=</span> <span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">flow_run_context</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_run_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.link_state_to_result" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">link_state_to_result</span></code>

<a href="#prefect.engine.link_state_to_result" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Caches a link between a state and a result and its components using
the <code>id</code> of the components to map to the state. The cache is persisted to the
current flow run context since task relationships are limited to within a flow run.</p>
<p>This allows dependency tracking to occur when results are passed around.
Note: Because <code>id</code> is used, we cannot cache links between singleton objects.</p>
<p>We only cache the relationship between components 1-layer deep.
Example:
    Given the result [1, ["a","b"], ("c",)], the following elements will be
    mapped to the state:
    - [1, ["a","b"], ("c",)]
    - ["a","b"]
    - ("c",)</p>
<div class="codehilite"><pre><span></span><code><span class="n">Note</span><span class="o">:</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="err">`</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">mapped</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">singleton</span><span class="o">.</span>
</code></pre></div>

<p>Other Notes:
We do not hash the result because:
- If changes are made to the object in the flow between task calls, we can still
  track that they are related.
- Hashing can be expensive.
- Not all objects are hashable.</p>
<p>We do not set an attribute, e.g. <code>__prefect_state__</code>, on the result because:</p>
<ul>
<li>Mutating user's objects is dangerous.</li>
<li>Unrelated equality comparisons can break unexpectedly.</li>
<li>The field can be preserved on copy.</li>
<li>We cannot set this attribute on Python built-ins.</li>
</ul>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">link_state_to_result</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caches a link between a state and a result and its components using</span>
<span class="sd">    the `id` of the components to map to the state. The cache is persisted to the</span>
<span class="sd">    current flow run context since task relationships are limited to within a flow run.</span>

<span class="sd">    This allows dependency tracking to occur when results are passed around.</span>
<span class="sd">    Note: Because `id` is used, we cannot cache links between singleton objects.</span>

<span class="sd">    We only cache the relationship between components 1-layer deep.</span>
<span class="sd">    Example:</span>
<span class="sd">        Given the result [1, [&quot;a&quot;,&quot;b&quot;], (&quot;c&quot;,)], the following elements will be</span>
<span class="sd">        mapped to the state:</span>
<span class="sd">        - [1, [&quot;a&quot;,&quot;b&quot;], (&quot;c&quot;,)]</span>
<span class="sd">        - [&quot;a&quot;,&quot;b&quot;]</span>
<span class="sd">        - (&quot;c&quot;,)</span>

<span class="sd">        Note: the int `1` will not be mapped to the state because it is a singleton.</span>

<span class="sd">    Other Notes:</span>
<span class="sd">    We do not hash the result because:</span>
<span class="sd">    - If changes are made to the object in the flow between task calls, we can still</span>
<span class="sd">      track that they are related.</span>
<span class="sd">    - Hashing can be expensive.</span>
<span class="sd">    - Not all objects are hashable.</span>

<span class="sd">    We do not set an attribute, e.g. `__prefect_state__`, on the result because:</span>

<span class="sd">    - Mutating user&#39;s objects is dangerous.</span>
<span class="sd">    - Unrelated equality comparisons can break unexpectedly.</span>
<span class="sd">    - The field can be preserved on copy.</span>
<span class="sd">    - We cannot set this attribute on Python built-ins.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">flow_run_context</span> <span class="o">=</span> <span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">link_if_trackable</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track connection between a task run result and its associated state if it has a unique ID.</span>

<span class="sd">        We cannot track booleans, Ellipsis, None, NotImplemented, or the integers from -5 to 256</span>
<span class="sd">        because they are singletons.</span>

<span class="sd">        This function will mutate the State if the object is an untrackable type by setting the value</span>
<span class="sd">        for `State.state_details.untrackable_result` to `True`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">UNTRACKABLE_TYPES</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">obj</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">untrackable_result</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_run_results</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">if</span> <span class="n">flow_run_context</span><span class="p">:</span>
        <span class="n">visit_collection</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">visit_fn</span><span class="o">=</span><span class="n">link_if_trackable</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.orchestrate_flow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">orchestrate_flow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.orchestrate_flow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Executes a flow run.</p>

<details class="note-on-flow-timeouts" open>
  <summary>Note on flow timeouts</summary>
  <p>Since async flows are run directly in the main event loop, timeout behavior will
match that described by anyio. If the flow is awaiting something, it will
immediately return; otherwise, the next time it awaits it will exit. Sync flows
are being task runner in a worker thread, which cannot be interrupted. The worker
thread will exit at the next task call. The worker thread also has access to the
status of the cancellation scope at <code>FlowRunContext.timeout_scope.cancel_called</code>
which allows it to raise a <code>TimeoutError</code> to respect the timeout.</p>
</details>


  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.states.State" href="../client/schemas/#prefect.client.schemas.objects.State">State</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The final state of the run</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">orchestrate_flow_run</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">,</span>
    <span class="n">flow_run</span><span class="p">:</span> <span class="n">FlowRun</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">interruptible</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
    <span class="n">partial_flow_run_context</span><span class="p">:</span> <span class="n">PartialModel</span><span class="p">[</span><span class="n">FlowRunContext</span><span class="p">],</span>
    <span class="n">user_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes a flow run.</span>

<span class="sd">    Note on flow timeouts:</span>
<span class="sd">        Since async flows are run directly in the main event loop, timeout behavior will</span>
<span class="sd">        match that described by anyio. If the flow is awaiting something, it will</span>
<span class="sd">        immediately return; otherwise, the next time it awaits it will exit. Sync flows</span>
<span class="sd">        are being task runner in a worker thread, which cannot be interrupted. The worker</span>
<span class="sd">        thread will exit at the next task call. The worker thread also has access to the</span>
<span class="sd">        status of the cancellation scope at `FlowRunContext.timeout_scope.cancel_called`</span>
<span class="sd">        which allows it to raise a `TimeoutError` to respect the timeout.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The final state of the run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>

    <span class="n">flow_run_context</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parent_flow_run_context</span> <span class="o">=</span> <span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Resolve futures in any non-data dependencies to ensure they are ready</span>
        <span class="k">if</span> <span class="n">wait_for</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">resolve_inputs</span><span class="p">({</span><span class="s2">&quot;wait_for&quot;</span><span class="p">:</span> <span class="n">wait_for</span><span class="p">},</span> <span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UpstreamTaskError</span> <span class="k">as</span> <span class="n">upstream_exc</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
            <span class="n">client</span><span class="p">,</span>
            <span class="n">Pending</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;NotReady&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">upstream_exc</span><span class="p">)),</span>
            <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="c1"># if orchestrating a run already in a pending state, force orchestration to</span>
            <span class="c1"># update the state name</span>
            <span class="n">force</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_pending</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Running</span><span class="p">(),</span> <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># flag to ensure we only update the flow run name once</span>
    <span class="n">run_name_set</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">while</span> <span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="n">waited_for_task_runs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Update the flow run to the latest data</span>
        <span class="n">flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_flow_run</span><span class="p">(</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">partial_flow_run_context</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span>
                <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span>
                <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">flow_run_context</span><span class="p">:</span>
                <span class="c1"># update flow run name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name_set</span> <span class="ow">and</span> <span class="n">flow</span><span class="o">.</span><span class="n">flow_run_name</span><span class="p">:</span>
                    <span class="n">flow_run_name</span> <span class="o">=</span> <span class="n">_resolve_custom_flow_run_name</span><span class="p">(</span>
                        <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span>
                    <span class="p">)</span>

                    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">update_flow_run</span><span class="p">(</span>
                        <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">flow_run_name</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s2">&quot;flow_run_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_run_name</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Renamed flow run </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> to </span><span class="si">{</span><span class="n">flow_run_name</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">flow_run</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">flow_run_name</span>
                    <span class="n">run_name_set</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parameters_to_args_kwargs</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Executing flow </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> for flow run </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">...&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">PREFECT_DEBUG_MODE</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing </span><span class="si">{</span><span class="n">call_repr</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Beginning execution...&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state_message&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                    <span class="p">)</span>

                <span class="n">flow_call</span> <span class="o">=</span> <span class="n">create_call</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c1"># This check for a parent call is needed for cases where the engine</span>
                <span class="c1"># was entered directly during testing</span>
                <span class="n">parent_call</span> <span class="o">=</span> <span class="n">get_current_call</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">parent_call</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">parent_flow_run_context</span>
                    <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">parent_flow_run_context</span>
                        <span class="ow">and</span> <span class="n">parent_flow_run_context</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">isasync</span> <span class="o">==</span> <span class="n">flow</span><span class="o">.</span><span class="n">isasync</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">from_async</span><span class="o">.</span><span class="n">call_soon_in_waiting_thread</span><span class="p">(</span>
                        <span class="n">flow_call</span><span class="p">,</span> <span class="n">thread</span><span class="o">=</span><span class="n">user_thread</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">timeout_seconds</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">from_async</span><span class="o">.</span><span class="n">call_soon_in_new_thread</span><span class="p">(</span>
                        <span class="n">flow_call</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">timeout_seconds</span>
                    <span class="p">)</span>

                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">flow_call</span><span class="o">.</span><span class="n">aresult</span><span class="p">()</span>

                <span class="n">waited_for_task_runs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">wait_for_task_runs_and_report_crashes</span><span class="p">(</span>
                    <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_run_futures</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">PausedRun</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># could get raised either via utility or by returning Paused from a task run</span>
            <span class="c1"># if a task run pauses, we set its state as the flow&#39;s state</span>
            <span class="c1"># to preserve reschedule and timeout behavior</span>
            <span class="n">paused_flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_flow_run</span><span class="p">(</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">paused_flow_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
                    <span class="n">client</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                    <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">state</span>
            <span class="n">paused_flow_run_state</span> <span class="o">=</span> <span class="n">paused_flow_run</span><span class="o">.</span><span class="n">state</span>
            <span class="k">return</span> <span class="n">paused_flow_run_state</span>
        <span class="k">except</span> <span class="n">CancelledError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_call</span><span class="o">.</span><span class="n">timedout</span><span class="p">():</span>
                <span class="c1"># If the flow call was not cancelled by us; this is a crash</span>
                <span class="k">raise</span>
            <span class="c1"># Construct a new exception as `TimeoutError`</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="ne">TimeoutError</span><span class="p">()</span>
            <span class="n">exc</span><span class="o">.</span><span class="n">__cause__</span> <span class="o">=</span> <span class="n">original</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Encountered exception during execution:&quot;</span><span class="p">)</span>
            <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span>
                <span class="n">exc</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Flow run exceeded timeout of </span><span class="si">{</span><span class="n">flow</span><span class="o">.</span><span class="n">timeout_seconds</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">,</span>
                <span class="n">result_factory</span><span class="o">=</span><span class="n">flow_run_context</span><span class="o">.</span><span class="n">result_factory</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;TimedOut&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Generic exception in user code</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Encountered exception during execution:&quot;</span><span class="p">)</span>
            <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Flow run encountered an exception.&quot;</span><span class="p">,</span>
                <span class="n">result_factory</span><span class="o">=</span><span class="n">flow_run_context</span><span class="o">.</span><span class="n">result_factory</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># All tasks and subflows are reference tasks if there is no return value</span>
                <span class="c1"># If there are no tasks, use `None` instead of an empty iterable</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_run_futures</span>
                    <span class="o">+</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_run_states</span>
                    <span class="o">+</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">flow_run_states</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>

            <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">return_value_to_state</span><span class="p">(</span>
                <span class="k">await</span> <span class="n">resolve_futures_to_states</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                <span class="n">result_factory</span><span class="o">=</span><span class="n">flow_run_context</span><span class="o">.</span><span class="n">result_factory</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">waited_for_task_runs</span><span class="p">:</span>
            <span class="c1"># An exception occurred that prevented us from waiting for task runs to</span>
            <span class="c1"># complete. Ensure that we wait for them before proposing a final state</span>
            <span class="c1"># for the flow run.</span>
            <span class="k">await</span> <span class="n">wait_for_task_runs_and_report_crashes</span><span class="p">(</span>
                <span class="n">flow_run_context</span><span class="o">.</span><span class="n">task_run_futures</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span>
            <span class="p">)</span>

        <span class="c1"># Before setting the flow run state, store state.data using</span>
        <span class="c1"># block storage and send the resulting data document to the Prefect API instead.</span>
        <span class="c1"># This prevents the pickled return value of flow runs</span>
        <span class="c1"># from being sent to the Prefect API and stored in the Prefect database.</span>
        <span class="c1"># state.data is left as is, otherwise we would have to load</span>
        <span class="c1"># the data from block storage again after storing.</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
            <span class="n">client</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">terminal_state</span><span class="p">,</span>
            <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">_run_flow_hooks</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span> <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">PREFECT_DEBUG_MODE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Received new state </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2"> when proposing final state&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">terminal_state</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;send_to_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_final</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_paused</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Received non-final state </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> when proposing final&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; state </span><span class="si">{</span><span class="n">terminal_state</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> and will attempt to run again...&quot;</span>
                <span class="p">),</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;send_to_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># Attempt to enter a running state again</span>
            <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Running</span><span class="p">(),</span> <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.orchestrate_task_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">orchestrate_task_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.orchestrate_task_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Execute a task run</p>
<p>This function should be submitted to an task runner. We must construct the context
here instead of receiving it already populated since we may be in a new environment.</p>
<p>Proposes a RUNNING state, then
- if accepted, the task user function will be run
- if rejected, the received state will be returned</p>
<p>When the user function is run, the result will be used to determine a final state
- if an exception is encountered, it is trapped and stored in a FAILED state
- otherwise, <code>return_value_to_state</code> is used to determine the state</p>
<p>If the final state is COMPLETED, we generate a cache key as specified by the task</p>
<p>The final state is then proposed
- if accepted, this is the final state and will be returned
- if rejected and a new final state is provided, it will be returned
- if rejected and a non-final state is provided, we will attempt to enter a RUNNING
    state again</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.states.State" href="../client/schemas/#prefect.client.schemas.objects.State">State</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The final state of the run</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">orchestrate_task_run</span><span class="p">(</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span>
    <span class="n">task_run</span><span class="p">:</span> <span class="n">TaskRun</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">wait_for</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">PrefectFuture</span><span class="p">]],</span>
    <span class="n">result_factory</span><span class="p">:</span> <span class="n">ResultFactory</span><span class="p">,</span>
    <span class="n">log_prints</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">interruptible</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a task run</span>

<span class="sd">    This function should be submitted to an task runner. We must construct the context</span>
<span class="sd">    here instead of receiving it already populated since we may be in a new environment.</span>

<span class="sd">    Proposes a RUNNING state, then</span>
<span class="sd">    - if accepted, the task user function will be run</span>
<span class="sd">    - if rejected, the received state will be returned</span>

<span class="sd">    When the user function is run, the result will be used to determine a final state</span>
<span class="sd">    - if an exception is encountered, it is trapped and stored in a FAILED state</span>
<span class="sd">    - otherwise, `return_value_to_state` is used to determine the state</span>

<span class="sd">    If the final state is COMPLETED, we generate a cache key as specified by the task</span>

<span class="sd">    The final state is then proposed</span>
<span class="sd">    - if accepted, this is the final state and will be returned</span>
<span class="sd">    - if rejected and a new final state is provided, it will be returned</span>
<span class="sd">    - if rejected and a non-final state is provided, we will attempt to enter a RUNNING</span>
<span class="sd">        state again</span>

<span class="sd">    Returns:</span>
<span class="sd">        The final state of the run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow_run_context</span> <span class="o">=</span> <span class="n">prefect</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">FlowRunContext</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">flow_run_context</span><span class="p">:</span>
        <span class="n">flow_run</span> <span class="o">=</span> <span class="n">flow_run_context</span><span class="o">.</span><span class="n">flow_run</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_flow_run</span><span class="p">(</span><span class="n">task_run</span><span class="o">.</span><span class="n">flow_run_id</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">task_run_logger</span><span class="p">(</span><span class="n">task_run</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">)</span>

    <span class="n">partial_task_run_context</span> <span class="o">=</span> <span class="n">PartialModel</span><span class="p">(</span>
        <span class="n">TaskRunContext</span><span class="p">,</span>
        <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span>
        <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
        <span class="n">result_factory</span><span class="o">=</span><span class="n">result_factory</span><span class="p">,</span>
        <span class="n">log_prints</span><span class="o">=</span><span class="n">log_prints</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Resolve futures in parameters into data</span>
        <span class="n">resolved_parameters</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resolve_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="c1"># Resolve futures in any non-data dependencies to ensure they are ready</span>
        <span class="k">await</span> <span class="n">resolve_inputs</span><span class="p">({</span><span class="s2">&quot;wait_for&quot;</span><span class="p">:</span> <span class="n">wait_for</span><span class="p">},</span> <span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">UpstreamTaskError</span> <span class="k">as</span> <span class="n">upstream_exc</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
            <span class="n">client</span><span class="p">,</span>
            <span class="n">Pending</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;NotReady&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">upstream_exc</span><span class="p">)),</span>
            <span class="n">task_run_id</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="c1"># if orchestrating a run already in a pending state, force orchestration to</span>
            <span class="c1"># update the state name</span>
            <span class="n">force</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_pending</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="c1"># Generate the cache key to attach to proposed states</span>
    <span class="c1"># The cache key uses a TaskRunContext that does not include a `timeout_context``</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">task</span><span class="o">.</span><span class="n">cache_key_fn</span><span class="p">(</span>
            <span class="n">partial_task_run_context</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">resolved_parameters</span><span class="p">),</span>
            <span class="n">resolved_parameters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">cache_key_fn</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">task_run_context</span> <span class="o">=</span> <span class="n">partial_task_run_context</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">resolved_parameters</span><span class="p">)</span>

    <span class="c1"># Ignore the cached results for a cache key, default = false</span>
    <span class="c1"># Setting on task level overrules the Prefect setting (env var)</span>
    <span class="n">refresh_cache</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">task</span><span class="o">.</span><span class="n">refresh_cache</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">refresh_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">PREFECT_TASKS_REFRESH_CACHE</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Emit an event to capture that the task run was in the `PENDING` state.</span>
    <span class="n">last_event</span> <span class="o">=</span> <span class="n">_emit_task_run_state_change_event</span><span class="p">(</span>
        <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validated_state</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">state</span>
    <span class="p">)</span>
    <span class="n">last_state</span> <span class="o">=</span> <span class="n">task_run</span><span class="o">.</span><span class="n">state</span>

    <span class="c1"># Transition from `PENDING` -&gt; `RUNNING`</span>
    <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
        <span class="n">client</span><span class="p">,</span>
        <span class="n">Running</span><span class="p">(</span>
            <span class="n">state_details</span><span class="o">=</span><span class="n">StateDetails</span><span class="p">(</span><span class="n">cache_key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">refresh_cache</span><span class="o">=</span><span class="n">refresh_cache</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">task_run_id</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Emit an event to capture the result of proposing a `RUNNING` state.</span>
    <span class="n">last_event</span> <span class="o">=</span> <span class="n">_emit_task_run_state_change_event</span><span class="p">(</span>
        <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="o">=</span><span class="n">last_state</span><span class="p">,</span>
        <span class="n">validated_state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
        <span class="n">follows</span><span class="o">=</span><span class="n">last_event</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># flag to ensure we only update the task run name once</span>
    <span class="n">run_name_set</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Only run the task if we enter a `RUNNING` state</span>
    <span class="k">while</span> <span class="n">state</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="c1"># Retrieve the latest metadata for the task run context</span>
        <span class="n">task_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_task_run</span><span class="p">(</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">task_run_context</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;task_run&quot;</span><span class="p">:</span> <span class="n">task_run</span><span class="p">,</span> <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">pendulum</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)}</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parameters_to_args_kwargs</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">resolved_parameters</span><span class="p">)</span>
                <span class="c1"># update task run name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name_set</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">task_run_name</span><span class="p">:</span>
                    <span class="n">task_run_name</span> <span class="o">=</span> <span class="n">_resolve_custom_task_run_name</span><span class="p">(</span>
                        <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">resolved_parameters</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">set_task_run_name</span><span class="p">(</span>
                        <span class="n">task_run_id</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">task_run_name</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s2">&quot;task_run_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_run_name</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Renamed task run </span><span class="si">{</span><span class="n">task_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> to </span><span class="si">{</span><span class="n">task_run_name</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">task_run</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">task_run_name</span>
                    <span class="n">run_name_set</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">PREFECT_DEBUG_MODE</span><span class="o">.</span><span class="n">value</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing </span><span class="si">{</span><span class="n">call_repr</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Beginning execution...&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state_message&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                    <span class="p">)</span>

                <span class="n">call</span> <span class="o">=</span> <span class="n">from_async</span><span class="o">.</span><span class="n">call_soon_in_new_thread</span><span class="p">(</span>
                    <span class="n">create_call</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">timeout_seconds</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">aresult</span><span class="p">()</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">CancelledError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">timedout</span><span class="p">():</span>
                    <span class="c1"># If the task call was not cancelled by us; this is a crash</span>
                    <span class="k">raise</span>
                <span class="c1"># Construct a new exception as `TimeoutError`</span>
                <span class="n">original</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="ne">TimeoutError</span><span class="p">()</span>
                <span class="n">exc</span><span class="o">.</span><span class="n">__cause__</span> <span class="o">=</span> <span class="n">original</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Encountered exception during execution:&quot;</span><span class="p">)</span>
                <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span>
                    <span class="n">exc</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Task run exceeded timeout of </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">timeout_seconds</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
                    <span class="p">),</span>
                    <span class="n">result_factory</span><span class="o">=</span><span class="n">task_run_context</span><span class="o">.</span><span class="n">result_factory</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;TimedOut&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Encountered exception during execution:&quot;</span><span class="p">)</span>
                <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span>
                    <span class="n">exc</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Task run encountered an exception&quot;</span><span class="p">,</span>
                    <span class="n">result_factory</span><span class="o">=</span><span class="n">task_run_context</span><span class="o">.</span><span class="n">result_factory</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">terminal_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">return_value_to_state</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">result_factory</span><span class="o">=</span><span class="n">task_run_context</span><span class="o">.</span><span class="n">result_factory</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># for COMPLETED tasks, add the cache key and expiration</span>
                <span class="k">if</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">is_completed</span><span class="p">():</span>
                    <span class="n">terminal_state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">cache_expiration</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">pendulum</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="s2">&quot;utc&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">cache_expiration</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">cache_expiration</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>
                    <span class="n">terminal_state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">cache_key</span> <span class="o">=</span> <span class="n">cache_key</span>

            <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">terminal_state</span><span class="p">,</span> <span class="n">task_run_id</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">last_event</span> <span class="o">=</span> <span class="n">_emit_task_run_state_change_event</span><span class="p">(</span>
                <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span>
                <span class="n">initial_state</span><span class="o">=</span><span class="n">last_state</span><span class="p">,</span>
                <span class="n">validated_state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">follows</span><span class="o">=</span><span class="n">last_event</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span>

            <span class="k">await</span> <span class="n">_run_task_hooks</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">terminal_state</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">PREFECT_DEBUG_MODE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Received new state </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2"> when proposing final state&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">terminal_state</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;send_to_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_final</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_paused</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Received non-final state </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> when proposing final&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; state </span><span class="si">{</span><span class="n">terminal_state</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> and will attempt to run&quot;</span>
                        <span class="s2">&quot; again...&quot;</span>
                    <span class="p">),</span>
                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;send_to_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="c1"># Attempt to enter a running state again</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Running</span><span class="p">(),</span> <span class="n">task_run_id</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">last_event</span> <span class="o">=</span> <span class="n">_emit_task_run_state_change_event</span><span class="p">(</span>
                    <span class="n">task_run</span><span class="o">=</span><span class="n">task_run</span><span class="p">,</span>
                    <span class="n">initial_state</span><span class="o">=</span><span class="n">last_state</span><span class="p">,</span>
                    <span class="n">validated_state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                    <span class="n">follows</span><span class="o">=</span><span class="n">last_event</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># If debugging, use the more complete `repr` than the usual `str` description</span>
    <span class="n">display_state</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">PREFECT_DEBUG_MODE</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_completed</span><span class="p">()</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Finished in state </span><span class="si">{</span><span class="n">display_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.pause_flow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pause_flow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.pause_flow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Pauses the current flow run by stopping execution until resumed.</p>
<p>When called within a flow run, execution will block and no downstream tasks will
run until the flow is resumed. Task runs that have already started will continue
running. A timeout parameter can be passed that will fail the flow run if it has not
been resumed within the specified time.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>flow_run_id</code></td>
          <td>
                <code><span title="uuid.UUID">UUID</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a flow run id. If supplied, this function will attempt to pause
the specified flow run outside of the flow run process. When paused, the
flow run will continue execution until the NEXT task is orchestrated, at
which point the flow will exit. Any tasks that have already started will
run until completion. When resumed, the flow run will be rescheduled to
finish execution. In order pause a flow run in this way, the flow needs to
have an associated deployment and results need to be configured with the
<code>persist_results</code> option.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>timeout</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the number of seconds to wait for the flow to be resumed before
failing. Defaults to 5 minutes (300 seconds). If the pause timeout exceeds
any configured flow-level timeout, the flow might fail even after resuming.</p>
            </div>
          </td>
          <td>
                <code>300</code>
          </td>
        </tr>
        <tr>
          <td><code>poll_interval</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of seconds between checking whether the flow has been
resumed. Defaults to 10 seconds.</p>
            </div>
          </td>
          <td>
                <code>10</code>
          </td>
        </tr>
        <tr>
          <td><code>reschedule</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Flag that will reschedule the flow run if resumed. Instead of
blocking execution, the flow will gracefully exit (with no result returned)
instead. To use this flag, a flow needs to have an associated deployment and
results need to be configured with the <code>persist_results</code> option.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An optional key to prevent calling pauses more than once. This defaults to
the number of pauses observed by the flow so far, and prevents pauses that
use the "reschedule" option from running the same pause twice. A custom key
can be supplied for custom pausing behavior.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@sync_compatible</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">pause_flow_run</span><span class="p">(</span>
    <span class="n">flow_run_id</span><span class="p">:</span> <span class="n">UUID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">reschedule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pauses the current flow run by stopping execution until resumed.</span>

<span class="sd">    When called within a flow run, execution will block and no downstream tasks will</span>
<span class="sd">    run until the flow is resumed. Task runs that have already started will continue</span>
<span class="sd">    running. A timeout parameter can be passed that will fail the flow run if it has not</span>
<span class="sd">    been resumed within the specified time.</span>

<span class="sd">    Args:</span>
<span class="sd">        flow_run_id: a flow run id. If supplied, this function will attempt to pause</span>
<span class="sd">            the specified flow run outside of the flow run process. When paused, the</span>
<span class="sd">            flow run will continue execution until the NEXT task is orchestrated, at</span>
<span class="sd">            which point the flow will exit. Any tasks that have already started will</span>
<span class="sd">            run until completion. When resumed, the flow run will be rescheduled to</span>
<span class="sd">            finish execution. In order pause a flow run in this way, the flow needs to</span>
<span class="sd">            have an associated deployment and results need to be configured with the</span>
<span class="sd">            `persist_results` option.</span>
<span class="sd">        timeout: the number of seconds to wait for the flow to be resumed before</span>
<span class="sd">            failing. Defaults to 5 minutes (300 seconds). If the pause timeout exceeds</span>
<span class="sd">            any configured flow-level timeout, the flow might fail even after resuming.</span>
<span class="sd">        poll_interval: The number of seconds between checking whether the flow has been</span>
<span class="sd">            resumed. Defaults to 10 seconds.</span>
<span class="sd">        reschedule: Flag that will reschedule the flow run if resumed. Instead of</span>
<span class="sd">            blocking execution, the flow will gracefully exit (with no result returned)</span>
<span class="sd">            instead. To use this flag, a flow needs to have an associated deployment and</span>
<span class="sd">            results need to be configured with the `persist_results` option.</span>
<span class="sd">        key: An optional key to prevent calling pauses more than once. This defaults to</span>
<span class="sd">            the number of pauses observed by the flow so far, and prevents pauses that</span>
<span class="sd">            use the &quot;reschedule&quot; option from running the same pause twice. A custom key</span>
<span class="sd">            can be supplied for custom pausing behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flow_run_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_out_of_process_pause</span><span class="p">(</span>
            <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run_id</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">reschedule</span><span class="o">=</span><span class="n">reschedule</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_in_process_pause</span><span class="p">(</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">,</span> <span class="n">reschedule</span><span class="o">=</span><span class="n">reschedule</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.propose_state" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propose_state</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.propose_state" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Propose a new state for a flow run or task run, invoking Prefect orchestration logic.</p>
<p>If the proposed state is accepted, the provided <code>state</code> will be augmented with
 details and returned.</p>
<p>If the proposed state is rejected, a new state returned by the Prefect API will be
returned.</p>
<p>If the proposed state results in a WAIT instruction from the Prefect API, the
function will sleep and attempt to propose the state again.</p>
<p>If the proposed state results in an ABORT instruction from the Prefect API, an
error will be raised.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>state</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.states.State" href="../client/schemas/#prefect.client.schemas.objects.State">State</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a new state for the task or flow run</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>task_run_id</code></td>
          <td>
                <code><span title="uuid.UUID">UUID</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>an optional task run id, used when proposing task run states</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>flow_run_id</code></td>
          <td>
                <code><span title="uuid.UUID">UUID</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>an optional flow run id, used when proposing flow run states</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.states.State" href="../client/schemas/#prefect.client.schemas.objects.State">State</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a <a class="autorefs autorefs-internal" href="../client/schemas/#prefect.client.schemas.objects.State">State model</a> representation of the
flow or task run state</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>ValueError</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if neither task_run_id or flow_run_id is provided</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.exceptions.Abort" href="../exceptions/#prefect.exceptions.Abort">Abort</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if an ABORT instruction is received from
the Prefect API</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">propose_state</span><span class="p">(</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">task_run_id</span><span class="p">:</span> <span class="n">UUID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">flow_run_id</span><span class="p">:</span> <span class="n">UUID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Propose a new state for a flow run or task run, invoking Prefect orchestration logic.</span>

<span class="sd">    If the proposed state is accepted, the provided `state` will be augmented with</span>
<span class="sd">     details and returned.</span>

<span class="sd">    If the proposed state is rejected, a new state returned by the Prefect API will be</span>
<span class="sd">    returned.</span>

<span class="sd">    If the proposed state results in a WAIT instruction from the Prefect API, the</span>
<span class="sd">    function will sleep and attempt to propose the state again.</span>

<span class="sd">    If the proposed state results in an ABORT instruction from the Prefect API, an</span>
<span class="sd">    error will be raised.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: a new state for the task or flow run</span>
<span class="sd">        task_run_id: an optional task run id, used when proposing task run states</span>
<span class="sd">        flow_run_id: an optional flow run id, used when proposing flow run states</span>

<span class="sd">    Returns:</span>
<span class="sd">        a [State model][prefect.client.schemas.objects.State] representation of the</span>
<span class="sd">            flow or task run state</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if neither task_run_id or flow_run_id is provided</span>
<span class="sd">        prefect.exceptions.Abort: if an ABORT instruction is received from</span>
<span class="sd">            the Prefect API</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Determine if working with a task run or flow run</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">task_run_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flow_run_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either a `task_run_id` or `flow_run_id`&quot;</span><span class="p">)</span>

    <span class="c1"># Handle task and sub-flow tracing</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_final</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">BaseResult</span><span class="p">)</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">has_cached_object</span><span class="p">():</span>
            <span class="c1"># Avoid fetching the result unless it is cached, otherwise we defeat</span>
            <span class="c1"># the purpose of disabling `cache_result_in_memory`</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">raise_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fetch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span>

        <span class="n">link_state_to_result</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="c1"># Handle repeated WAITs in a loop instead of recursively, to avoid</span>
    <span class="c1"># reaching max recursion depth in extreme cases.</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_state_and_handle_waits</span><span class="p">(</span><span class="n">set_state_func</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrchestrationResult</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">set_state_func</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetStateStatus</span><span class="o">.</span><span class="n">WAIT</span><span class="p">:</span>
            <span class="n">engine_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Received wait instruction for </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">delay_seconds</span><span class="si">}</span><span class="s2">s: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">anyio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">delay_seconds</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">set_state_func</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="c1"># Attempt to set the state</span>
    <span class="k">if</span> <span class="n">task_run_id</span><span class="p">:</span>
        <span class="n">set_state</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">set_task_run_state</span><span class="p">,</span> <span class="n">task_run_id</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">set_state_and_handle_waits</span><span class="p">(</span><span class="n">set_state</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">flow_run_id</span><span class="p">:</span>
        <span class="n">set_state</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">set_flow_run_state</span><span class="p">,</span> <span class="n">flow_run_id</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">set_state_and_handle_waits</span><span class="p">(</span><span class="n">set_state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Neither flow run id or task run id were provided. At least one must &quot;</span>
            <span class="s2">&quot;be given.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Parse the response to return the new state</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetStateStatus</span><span class="o">.</span><span class="n">ACCEPT</span><span class="p">:</span>
        <span class="c1"># Update the state with the details if provided</span>
        <span class="n">state</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">id</span>
        <span class="n">state</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state_details</span><span class="p">:</span>
            <span class="n">state</span><span class="o">.</span><span class="n">state_details</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state_details</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetStateStatus</span><span class="o">.</span><span class="n">ABORT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">prefect</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Abort</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetStateStatus</span><span class="o">.</span><span class="n">REJECT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_paused</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Pause</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Received unexpected `SetStateStatus` from server: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.report_flow_run_crashes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">report_flow_run_crashes</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.report_flow_run_crashes" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Detect flow run crashes during this context and update the run to a proper final
state.</p>
<p>This context <em>must</em> reraise the exception to properly exit the run.</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">report_flow_run_crashes</span><span class="p">(</span><span class="n">flow_run</span><span class="p">:</span> <span class="n">FlowRun</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span> <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect flow run crashes during this context and update the run to a proper final</span>
<span class="sd">    state.</span>

<span class="sd">    This context _must_ reraise the exception to properly exit the run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Abort</span><span class="p">,</span> <span class="n">Pause</span><span class="p">):</span>
        <span class="c1"># Do not capture internal signals as crashes</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_crashed_state</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">anyio</span><span class="o">.</span><span class="n">CancelScope</span><span class="p">(</span><span class="n">shield</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crash detected! </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Crash details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">flow_run_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">engine_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reported crashed flow run </span><span class="si">{</span><span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> successfully!&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Only `on_crashed` and `on_cancellation` flow run state change hooks can be called here.</span>
            <span class="c1"># We call the hooks after the state change proposal to `CRASHED` is validated</span>
            <span class="c1"># or rejected (if it is in a `CANCELLING` state).</span>
            <span class="k">await</span> <span class="n">_run_flow_hooks</span><span class="p">(</span>
                <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">flow_run_state</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Reraise the exception</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.report_task_run_crashes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">report_task_run_crashes</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.report_task_run_crashes" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Detect task run crashes during this context and update the run to a proper final
state.</p>
<p>This context <em>must</em> reraise the exception to properly exit the run.</p>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">report_task_run_crashes</span><span class="p">(</span><span class="n">task_run</span><span class="p">:</span> <span class="n">TaskRun</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect task run crashes during this context and update the run to a proper final</span>
<span class="sd">    state.</span>

<span class="sd">    This context _must_ reraise the exception to properly exit the run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Abort</span><span class="p">,</span> <span class="n">Pause</span><span class="p">):</span>
        <span class="c1"># Do not capture internal signals as crashes</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_crashed_state</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">task_run_logger</span><span class="p">(</span><span class="n">task_run</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">anyio</span><span class="o">.</span><span class="n">CancelScope</span><span class="p">(</span><span class="n">shield</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crash detected! </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Crash details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">set_task_run_state</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">task_run_id</span><span class="o">=</span><span class="n">task_run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">engine_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reported crashed task run </span><span class="si">{</span><span class="n">task_run</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> successfully!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Reraise the exception</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.resolve_inputs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">resolve_inputs</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.resolve_inputs" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Resolve any <code>Quote</code>, <code>PrefectFuture</code>, or <code>State</code> types nested in parameters into
data.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A copy of the parameters with resolved data</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="prefect.exceptions.UpstreamTaskError" href="../exceptions/#prefect.exceptions.UpstreamTaskError">UpstreamTaskError</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If any of the upstream states are not <code>COMPLETED</code></p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">resolve_inputs</span><span class="p">(</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">return_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve any `Quote`, `PrefectFuture`, or `State` types nested in parameters into</span>
<span class="sd">    data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A copy of the parameters with resolved data</span>

<span class="sd">    Raises:</span>
<span class="sd">        UpstreamTaskError: If any of the upstream states are not `COMPLETED`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">futures</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">states</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">result_by_state</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">collect_futures_and_states</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># Expressions inside quotes should not be traversed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">),</span> <span class="n">quote</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StopVisiting</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">PrefectFuture</span><span class="p">):</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_state</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
            <span class="n">states</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">expr</span>

    <span class="n">visit_collection</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="n">visit_fn</span><span class="o">=</span><span class="n">collect_futures_and_states</span><span class="p">,</span>
        <span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">)</span>

    <span class="c1"># Wait for all futures so we do not block when we retrieve the state in `resolve_input`</span>
    <span class="n">states</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">_wait</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]))</span>

    <span class="c1"># Only retrieve the result if requested as it may be expensive</span>
    <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="n">finished_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">is_final</span><span class="p">()]</span>

        <span class="n">state_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span>
                <span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">raise_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fetch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">finished_states</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">finished_states</span><span class="p">,</span> <span class="n">state_results</span><span class="p">):</span>
            <span class="n">result_by_state</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">resolve_input</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Expressions inside quotes should not be modified</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">),</span> <span class="n">quote</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StopVisiting</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">PrefectFuture</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">_final_state</span>
        <span class="k">elif</span> <span class="n">is_state</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expr</span>

        <span class="c1"># Do not allow uncompleted upstreams except failures when `allow_failure` has</span>
        <span class="c1"># been used</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">is_completed</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="c1"># TODO: Note that the contextual annotation here is only at the current level</span>
            <span class="c1">#       if `allow_failure` is used then another annotation is used, this will</span>
            <span class="c1">#       incorrectly evaluate to false — to resolve this, we must track all</span>
            <span class="c1">#       annotations wrapping the current expression but this is not yet</span>
            <span class="c1">#       implemented.</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">),</span> <span class="n">allow_failure</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">UpstreamTaskError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Upstream task run &#39;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">state_details</span><span class="o">.</span><span class="n">task_run_id</span><span class="si">}</span><span class="s2">&#39; did not reach a&quot;</span>
                <span class="s2">&quot; &#39;COMPLETED&#39; state.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result_by_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">resolved_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved_parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">visit_collection</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">visit_fn</span><span class="o">=</span><span class="n">resolve_input</span><span class="p">,</span>
                <span class="n">return_data</span><span class="o">=</span><span class="n">return_data</span><span class="p">,</span>
                <span class="c1"># we&#39;re manually going 1 layer deeper here</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">remove_annotations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="p">{},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">UpstreamTaskError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PrefectException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to resolve inputs in parameter </span><span class="si">{</span><span class="n">parameter</span><span class="si">!r}</span><span class="s2">. If your&quot;</span>
                <span class="s2">&quot; parameter type is not supported, consider using the `quote`&quot;</span>
                <span class="s2">&quot; annotation to skip resolution of inputs.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="k">return</span> <span class="n">resolved_parameters</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.resume_flow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">resume_flow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.resume_flow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Resumes a paused flow.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>flow_run_id</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the flow_run_id to resume</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@sync_compatible</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">resume_flow_run</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resumes a paused flow.</span>

<span class="sd">    Args:</span>
<span class="sd">        flow_run_id: the flow_run_id to resume</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">get_client</span><span class="p">()</span>
    <span class="n">flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_flow_run</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_paused</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">NotPausedError</span><span class="p">(</span><span class="s2">&quot;Cannot resume a run that isn&#39;t paused!&quot;</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">resume_flow_run</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SetStateStatus</span><span class="o">.</span><span class="n">REJECT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">StateType</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FlowPauseTimeout</span><span class="p">(</span><span class="s2">&quot;Flow run can no longer be resumed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot resume this run: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="prefect.engine.retrieve_flow_then_begin_flow_run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">retrieve_flow_then_begin_flow_run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#prefect.engine.retrieve_flow_then_begin_flow_run" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Async entrypoint for flow runs that have been submitted for execution by an agent</p>
<ul>
<li>Retrieves the deployment information</li>
<li>Loads the flow object using deployment information</li>
<li>Updates the flow run version</li>
</ul>

          <details class="quote">
            <summary>Source code in <code>prefect/engine.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@inject_client</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_flow_then_begin_flow_run</span><span class="p">(</span>
    <span class="n">flow_run_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">PrefectClient</span><span class="p">,</span>
    <span class="n">user_thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Async entrypoint for flow runs that have been submitted for execution by an agent</span>

<span class="sd">    - Retrieves the deployment information</span>
<span class="sd">    - Loads the flow object using deployment information</span>
<span class="sd">    - Updates the flow run version</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow_run</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_flow_run</span><span class="p">(</span><span class="n">flow_run_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_flow_from_flow_run</span><span class="p">(</span><span class="n">flow_run</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Flow could not be retrieved from deployment.&quot;</span>
        <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">set_flow_run_state</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run_id</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="c1"># Update the flow run policy defaults to match settings on the flow</span>
    <span class="c1"># Note: Mutating the flow run object prevents us from performing another read</span>
    <span class="c1">#       operation if these properties are used by the client downstream</span>
    <span class="k">if</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">empirical_policy</span><span class="o">.</span><span class="n">retry_delay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flow_run</span><span class="o">.</span><span class="n">empirical_policy</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">retry_delay_seconds</span>

    <span class="k">if</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">empirical_policy</span><span class="o">.</span><span class="n">retries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flow_run</span><span class="o">.</span><span class="n">empirical_policy</span><span class="o">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">retries</span>

    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">update_flow_run</span><span class="p">(</span>
        <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run_id</span><span class="p">,</span>
        <span class="n">flow_version</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
        <span class="n">empirical_policy</span><span class="o">=</span><span class="n">flow_run</span><span class="o">.</span><span class="n">empirical_policy</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">should_validate_parameters</span><span class="p">:</span>
        <span class="n">failed_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">validate_parameters</span><span class="p">(</span><span class="n">flow_run</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Validation of flow parameters failed with error: &quot;</span>
            <span class="n">flow_run_logger</span><span class="p">(</span><span class="n">flow_run</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">failed_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">exception_to_failed_state</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">failed_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">propose_state</span><span class="p">(</span>
                <span class="n">client</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">failed_state</span><span class="p">,</span>
                <span class="n">flow_run_id</span><span class="o">=</span><span class="n">flow_run_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">failed_state</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Ensure default values are populated</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">get_parameter_defaults</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">fn</span><span class="p">),</span> <span class="o">**</span><span class="n">parameters</span><span class="p">}</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">begin_flow_run</span><span class="p">(</span>
        <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
        <span class="n">flow_run</span><span class="o">=</span><span class="n">flow_run</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
        <span class="n">user_thread</span><span class="o">=</span><span class="n">user_thread</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

  
  



  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thank you for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thank you for your feedback! Feel free to <a href="https://github.com/PrefectHQ/prefect/issues/new?assignees=&amp;labels=docs%2Cstatus%3Atriage&amp;projects=&amp;template=4_docs_change.yaml" target="_blank" rel="noopener"> open an issue </a> with more detail.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.code.copy", "navigation.tabs.sticky", "search.suggest", "search.highlight", "navigation.path", "navigation.indexes", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.f2da59ea.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.1c5acf9f.min.js"></script>
      
        <script src="../../../js/custom.js"></script>
      
        <script src="../../../js/termynal.js"></script>
      
    
  </body>
</html>