
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Prefect Python API for infrastructure definition.">
      
      
      
        <link rel="canonical" href="https://docs.prefect.io/2.8.1/api-ref/prefect/infrastructure/">
      
      
        <link rel="prev" href="../futures/">
      
      
        <link rel="next" href="../logging/">
      
      <link rel="icon" href="../../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.4">
    
    
      
        <title>prefect.infrastructure - Prefect 2 - Coordinating the world's dataflows</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.240905d7.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/theme.css">
    
      <link rel="stylesheet" href="../../../stylesheets/admonitions.css">
    
      <link rel="stylesheet" href="../../../stylesheets/api_ref.css">
    
      <link rel="stylesheet" href="../../../stylesheets/rest_ref.css">
    
      <link rel="stylesheet" href="../../../stylesheets/syntax_highlights.css">
    
      <link rel="stylesheet" href="../../../stylesheets/termynal.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3M31G9B0QJ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-3M31G9B0QJ');
</script>
<!-- Segment analytics -->
<script>
    !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var key=analytics.methods[e];analytics[key]=analytics.factory(key)}analytics.load=function(key,e){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);analytics._loadOptions=e};analytics._writeKey="xDLAoTXsNYpC4Y6JucKnJ8W1MYBuyAbD";;analytics.SNIPPET_VERSION="4.15.3";
    analytics.load("xDLAoTXsNYpC4Y6JucKnJ8W1MYBuyAbD");
    analytics.page();
    }}();
</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prefect.infrastructure" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
<div style="color: white;">
  <a href="https://github.com/PrefectHQ/prefect/blob/main/RELEASE-NOTES.md#release-281" style="color: #07e798;">
    <strong>Prefect 2.8.1 is live!</strong>
  </a> We've replaced "Orion" in commands, components, and the API with more explicit nomenclature, plus 
  <a href="https://github.com/PrefectHQ/prefect/blob/main/RELEASE-NOTES.md#release-281" style="color: #07e798;">
    <strong>much more!</strong>
  </a>
</div>

<!-- <div style="color: white;">
    Looking for the 
    <a href="http://docs-v1.prefect.io/" style="color: #07e798;">
      <strong>Prefect 1 docs</strong>
    </a> for Prefect 1 Core and Server? Find them at: 
    <a href="http://docs-v1.prefect.io/" style="color: #07e798;">
      <strong>http://docs-v1.prefect.io/</strong>
    </a>
  </div> -->

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're viewing the docs for Prefect 2.8.1.
  <a href="../../../.."> 
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Prefect 2 - Coordinating the world&#39;s dataflows" class="md-header__button md-logo" aria-label="Prefect 2 - Coordinating the world's dataflows" data-md-component="logo">
      
  <img src="../../../img/logos/prefect-logo-mark-solid-white-500.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Prefect 2 - Coordinating the world's dataflows
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              prefect.infrastructure
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_3" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_3">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/PrefectHQ/prefect" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      <!-- overrides partial for header navigation, adding tab for Prefect Cloud -->


<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
    
    
  
  
    
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          Getting Started
        </a>
      </li>
    
  
      
        
    
    
  
  
    
    
    
      <li class="md-tabs__item">
        <a href="../../../concepts/overview/" class="md-tabs__link">
          Concepts
        </a>
      </li>
    
  
      
        
    
    
  
  
    
    
    
      <li class="md-tabs__item">
        <a href="../../../ui/overview/" class="md-tabs__link">
          Prefect UI & Prefect Cloud
        </a>
      </li>
    
  
      
        
    
    
  
  
    
    
    
      <li class="md-tabs__item">
        <a href="../../../collections/catalog/" class="md-tabs__link">
          Integrations
        </a>
      </li>
    
  
      
        
    
    
  
  
    <li class="md-tabs__item">
      <a href="../../../faq/" class="md-tabs__link">
        FAQ
      </a>
    </li>
  
      
        
    
    
      
    
  
  
    
    
    
      <li class="md-tabs__item">
        <a href="../../overview/" class="md-tabs__link md-tabs__link--active">
          API Reference
        </a>
      </li>
    
  
      
        
    
    
  
  
    
    
    
      <li class="md-tabs__item">
        <a href="../../../contributing/overview/" class="md-tabs__link">
          Contributing
        </a>
      </li>
    
  
      
      <li class="md-tabs__item cloud-link"><a class="md-tabs__link" target="_blank" rel="noopener noreferrer" href="https://app.prefect.cloud"><b>Go to Prefect Cloud &#187;</b></a></li>
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Prefect 2 - Coordinating the world&#39;s dataflows" class="md-nav__button md-logo" aria-label="Prefect 2 - Coordinating the world's dataflows" data-md-component="logo">
      
  <img src="../../../img/logos/prefect-logo-mark-solid-white-500.png" alt="logo">

    </a>
    Prefect 2 - Coordinating the world's dataflows
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PrefectHQ/prefect" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome to Prefect 2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/overview/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
      
      
      
        <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_4">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1_4_1" id="__nav_1_4_1_label" tabindex="0">
          Prefect Fundamentals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_4_1">
          <span class="md-nav__icon md-icon"></span>
          Prefect Fundamentals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/first-steps/" class="md-nav__link">
        First steps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/flow-task-config/" class="md-nav__link">
        Flow and task configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/execution/" class="md-nav__link">
        Flow and task execution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/orchestration/" class="md-nav__link">
        Flow orchestration with Prefect
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/deployments/" class="md-nav__link">
        Flow deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/storage/" class="md-nav__link">
        Storage and Infrastructure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/docker/" class="md-nav__link">
        Running flows with Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/cloud-quickstart/" class="md-nav__link">
        Prefect Cloud Quickstart
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_1_4_2" id="__nav_1_4_2_label" tabindex="0">
          Advanced Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_4_2">
          <span class="md-nav__icon md-icon"></span>
          Advanced Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dask-ray-task-runners/" class="md-nav__link">
        Dask and Ray task runners
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../migration-guide/" class="md-nav__link">
        Migration Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_6" >
      
      
      
        <label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
          Prefect Recipes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1_6">
          <span class="md-nav__icon md-icon"></span>
          Prefect Recipes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../recipes/recipes/" class="md-nav__link">
        Recipes Catalog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../recipes/contribute-recipes/" class="md-nav__link">
        Contributing Recipes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/flows/" class="md-nav__link">
        Flows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/tasks/" class="md-nav__link">
        Tasks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/results/" class="md-nav__link">
        Results
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/states/" class="md-nav__link">
        States
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/infrastructure/" class="md-nav__link">
        Infrastructure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/task-runners/" class="md-nav__link">
        Task Runners
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/deployments/" class="md-nav__link">
        Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/work-pools/" class="md-nav__link">
        Agents & Work Pools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/storage/" class="md-nav__link">
        Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/blocks/" class="md-nav__link">
        Blocks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/filesystems/" class="md-nav__link">
        Filesystems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/schedules/" class="md-nav__link">
        Schedules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/logs/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/database/" class="md-nav__link">
        Database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/settings/" class="md-nav__link">
        Settings
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Prefect UI & Prefect Cloud
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Prefect UI & Prefect Cloud
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/overview/" class="md-nav__link">
        Prefect UI Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/cloud/" class="md-nav__link">
        Prefect Cloud Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/cloud-quickstart/" class="md-nav__link">
        Prefect Cloud Quickstart
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          Prefect Cloud Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Prefect Cloud Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/cloud-api-keys/" class="md-nav__link">
        Manage API keys
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/cloud-local-environment/" class="md-nav__link">
        Configure Local Environments
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/flow-runs/" class="md-nav__link">
        Flow Runs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/flows/" class="md-nav__link">
        Flows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/deployments/" class="md-nav__link">
        Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/work-pools/" class="md-nav__link">
        Work Pools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/blocks/" class="md-nav__link">
        Blocks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/notifications/" class="md-nav__link">
        Notifications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/task-concurrency/" class="md-nav__link">
        Task Run Concurrency
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/workspaces/" class="md-nav__link">
        Workspaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/automations/" class="md-nav__link">
        Automations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/organizations/" class="md-nav__link">
        Organizations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/service-accounts/" class="md-nav__link">
        Service Accounts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/roles/" class="md-nav__link">
        Roles (RBAC)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/sso/" class="md-nav__link">
        Single Sign-on (SSO)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/audit-log/" class="md-nav__link">
        Audit Log
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ui/rate-limits/" class="md-nav__link">
        Prefect Cloud API Rate Limits
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Integrations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Integrations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../collections/catalog/" class="md-nav__link">
        Collections Catalog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../collections/usage/" class="md-nav__link">
        Using Collections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../collections/contribute/" class="md-nav__link">
        Contributing Collections
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
          Prefect Python API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Prefect Python API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        prefect.agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../context/" class="md-nav__link">
        prefect.context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deployments/" class="md-nav__link">
        prefect.deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../engine/" class="md-nav__link">
        prefect.engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        prefect.exceptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../filesystems/" class="md-nav__link">
        prefect.filesystems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../flows/" class="md-nav__link">
        prefect.flows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../futures/" class="md-nav__link">
        prefect.futures
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          prefect.infrastructure
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        prefect.infrastructure
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.DockerContainer" class="md-nav__link">
    DockerContainer
  </a>
  
    <nav class="md-nav" aria-label="DockerContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.DockerContainer--connecting-to-a-locally-hosted-prefect-api" class="md-nav__link">
    Connecting to a locally hosted Prefect API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.DockerContainerResult" class="md-nav__link">
    DockerContainerResult
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.Infrastructure" class="md-nav__link">
    Infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.base.Infrastructure.prepare_for_flow_run" class="md-nav__link">
    prepare_for_flow_run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.base.Infrastructure.preview" class="md-nav__link">
    preview()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.base.Infrastructure.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.KubernetesClusterConfig" class="md-nav__link">
    KubernetesClusterConfig
  </a>
  
    <nav class="md-nav" aria-label="KubernetesClusterConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect.blocks.kubernetes.KubernetesClusterConfig.configure_client" class="md-nav__link">
    configure_client()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.blocks.kubernetes.KubernetesClusterConfig.from_file" class="md-nav__link">
    from_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.blocks.kubernetes.KubernetesClusterConfig.get_api_client" class="md-nav__link">
    get_api_client()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.KubernetesJob" class="md-nav__link">
    KubernetesJob
  </a>
  
    <nav class="md-nav" aria-label="KubernetesJob">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.kubernetes.KubernetesJob.base_job_manifest" class="md-nav__link">
    base_job_manifest()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.kubernetes.KubernetesJob.build_job" class="md-nav__link">
    build_job()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.kubernetes.KubernetesJob.customize_from_file" class="md-nav__link">
    customize_from_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect.infrastructure.kubernetes.KubernetesJob.job_from_file" class="md-nav__link">
    job_from_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.KubernetesJobResult" class="md-nav__link">
    KubernetesJobResult
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.Process" class="md-nav__link">
    Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefect.infrastructure.ProcessResult" class="md-nav__link">
    ProcessResult
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        prefect.logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../packaging/" class="md-nav__link">
        prefect.packaging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../serializers/" class="md-nav__link">
        prefect.serializers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../settings/" class="md-nav__link">
        prefect.settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../states/" class="md-nav__link">
        prefect.states
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../task-runners/" class="md-nav__link">
        prefect.task_runners
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tasks/" class="md-nav__link">
        prefect.tasks
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_17" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2_17" id="__nav_6_2_17_label" tabindex="0">
          Blocks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2_17">
          <span class="md-nav__icon md-icon"></span>
          Blocks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/core/" class="md-nav__link">
        prefect.blocks.core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/kubernetes/" class="md-nav__link">
        prefect.blocks.kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/notifications/" class="md-nav__link">
        prefect.blocks.notifications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blocks/system/" class="md-nav__link">
        prefect.blocks.system
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_18" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2_18" id="__nav_6_2_18_label" tabindex="0">
          Client
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_18_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2_18">
          <span class="md-nav__icon md-icon"></span>
          Client
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/base/" class="md-nav__link">
        prefect.client.base
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/cloud/" class="md-nav__link">
        prefect.client.cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/orchestration/" class="md-nav__link">
        prefect.client.orchestration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/schemas/" class="md-nav__link">
        prefect.client.schemas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/utilities/" class="md-nav__link">
        prefect.client.utilities
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_19" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2_19" id="__nav_6_2_19_label" tabindex="0">
          Command Line Interface
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2_19">
          <span class="md-nav__icon md-icon"></span>
          Command Line Interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/agent/" class="md-nav__link">
        prefect.cli.agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/cloud/" class="md-nav__link">
        prefect.cli.cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/concurrency_limit/" class="md-nav__link">
        prefect.cli.concurrency_limit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/config/" class="md-nav__link">
        prefect.cli.config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/dev/" class="md-nav__link">
        prefect.cli.dev
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/profile/" class="md-nav__link">
        prefect.cli.profile
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/work_queue/" class="md-nav__link">
        prefect.cli.work_queue
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/root/" class="md-nav__link">
        prefect.cli.root
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/deployment/" class="md-nav__link">
        prefect.cli.deployment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/flow_run/" class="md-nav__link">
        prefect.cli.flow_run
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/server/" class="md-nav__link">
        prefect.cli.server
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2_20" >
      
      
      
        <label class="md-nav__link" for="__nav_6_2_20" id="__nav_6_2_20_label" tabindex="0">
          Utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_20_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_2_20">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/annotations/" class="md-nav__link">
        prefect.utilities.annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/asyncutils/" class="md-nav__link">
        prefect.utilities.asyncutils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/processutils/" class="md-nav__link">
        prefect.utilities.processutils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/callables/" class="md-nav__link">
        prefect.utilities.callables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/collections/" class="md-nav__link">
        prefect.utilities.collections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/filesystem/" class="md-nav__link">
        prefect.utilities.filesystem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/hashing/" class="md-nav__link">
        prefect.utilities.hashing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
          Prefect Server API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Prefect Server API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_1" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_1" id="__nav_6_3_1_label" tabindex="0">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_1">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/admin/" class="md-nav__link">
        server.api.admin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/dependencies/" class="md-nav__link">
        server.api.dependencies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/deployments/" class="md-nav__link">
        server.api.deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/flows/" class="md-nav__link">
        server.api.flows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/flow_runs/" class="md-nav__link">
        server.api.flow_runs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/flow_run_states/" class="md-nav__link">
        server.api.flow_run_states
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/run_history/" class="md-nav__link">
        server.api.run_history
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/saved_searches/" class="md-nav__link">
        server.api.saved_searches
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/server/" class="md-nav__link">
        server.api.server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/task_runs/" class="md-nav__link">
        server.api.task_runs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/api/task_run_states/" class="md-nav__link">
        server.api.task_run_states
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_2" id="__nav_6_3_2_label" tabindex="0">
          Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_2">
          <span class="md-nav__icon md-icon"></span>
          Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/flows/" class="md-nav__link">
        server.models.flows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/flow_runs/" class="md-nav__link">
        server.models.flow_runs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/flow_run_states/" class="md-nav__link">
        server.models.flow_run_states
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/task_runs/" class="md-nav__link">
        server.models.task_runs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/task_run_states/" class="md-nav__link">
        server.models.task_run_states
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/deployments/" class="md-nav__link">
        server.models.deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/models/saved_searches/" class="md-nav__link">
        server.models.saved_searches
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_3" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_3" id="__nav_6_3_3_label" tabindex="0">
          Orchestration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_3">
          <span class="md-nav__icon md-icon"></span>
          Orchestration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/rules/" class="md-nav__link">
        server.orchestration.rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/policies/" class="md-nav__link">
        server.orchestration.policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/core_policy/" class="md-nav__link">
        server.orchestration.core_policy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/orchestration/global_policy/" class="md-nav__link">
        server.orchestration.global_policy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_4" id="__nav_6_3_4_label" tabindex="0">
          Schemas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_4">
          <span class="md-nav__icon md-icon"></span>
          Schemas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/actions/" class="md-nav__link">
        server.schemas.actions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/core/" class="md-nav__link">
        server.schemas.core
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/filters/" class="md-nav__link">
        server.schemas.filters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/responses/" class="md-nav__link">
        server.schemas.responses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/schedules/" class="md-nav__link">
        server.schemas.schedules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/sorting/" class="md-nav__link">
        server.schemas.sorting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/schemas/states/" class="md-nav__link">
        server.schemas.states
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_5" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_5" id="__nav_6_3_5_label" tabindex="0">
          Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_5">
          <span class="md-nav__icon md-icon"></span>
          Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/services/late_runs/" class="md-nav__link">
        server.services.late_runs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/services/loop_service/" class="md-nav__link">
        server.services.loop_service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/services/scheduler/" class="md-nav__link">
        server.services.scheduler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6_3_6" id="__nav_6_3_6_label" tabindex="0">
          Utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_3_6">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/utilities/database/" class="md-nav__link">
        server.utilities.database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/utilities/schemas/" class="md-nav__link">
        server.utilities.schemas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../server/utilities/server/" class="md-nav__link">
        server.utilities.server
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
      
      
      
        <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
          Prefect REST API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Prefect REST API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rest-api/" class="md-nav__link">
        Prefect REST API Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rest-api-reference/" class="md-nav__link">
        Prefect REST API Reference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/style/" class="md-nav__link">
        Style
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/versioning/" class="md-nav__link">
        Versioning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/common-mistakes/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<div class="doc doc-object doc-module">



<h1 id="prefect.infrastructure" class="doc doc-heading">
          <code>prefect.infrastructure</code>


<a href="#prefect.infrastructure" class="headerlink" title="Permanent link">&para;</a></h1>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.DockerContainer" class="doc doc-heading">
        <code>DockerContainer</code>


<a href="#prefect.infrastructure.DockerContainer" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="prefect.infrastructure.base.Infrastructure" href="#prefect.infrastructure.Infrastructure">Infrastructure</a></code></p>

  
      <p>Runs a command in a container.</p>
<p>Requires a Docker Engine to be connectable. Docker settings will be retrieved from
the environment.</p>
<p>Click <a href="https://docs.prefect.io/tutorials/docker/">here</a> to see a tutorial.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>auto_remove</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If set, the container will be removed on completion. Otherwise,
the container will remain after exit for inspection.</p></td>
        </tr>
        <tr>
          <td><code>command</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>A list of strings specifying the command to run in the container to
start the flow run. In most cases you should not override this.</p></td>
        </tr>
        <tr>
          <td><code>env</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Environment variables to set for the container.</p></td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>An optional string specifying the tag of a Docker image to use.
Defaults to the Prefect image.</p></td>
        </tr>
        <tr>
          <td><code>image_pull_policy</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="prefect.infrastructure.docker.ImagePullPolicy">ImagePullPolicy</span>]</code>
          </td>
          <td><p>Specifies if the image should be pulled. One of 'ALWAYS',
'NEVER', 'IF_NOT_PRESENT'.</p></td>
        </tr>
        <tr>
          <td><code>image_registry</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="prefect.infrastructure.docker.DockerRegistry">DockerRegistry</span>]</code>
          </td>
          <td><p>A <code>DockerRegistry</code> block containing credentials to use if <code>image</code> is stored in a private
image registry.</p></td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="prefect.infrastructure.docker.DockerRegistry">DockerRegistry</span>]</code>
          </td>
          <td><p>An optional dictionary of labels, mapping name to value.</p></td>
        </tr>
        <tr>
          <td><code>name</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="prefect.infrastructure.docker.DockerRegistry">DockerRegistry</span>]</code>
          </td>
          <td><p>An optional name for the container.</p></td>
        </tr>
        <tr>
          <td><code>network_mode</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td><p>Set the network mode for the created container. Defaults to 'host'
if a local API url is detected, otherwise the Docker default of 'bridge' is
used. If 'networks' is set, this cannot be set.</p></td>
        </tr>
        <tr>
          <td><code>networks</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>An optional list of strings specifying Docker networks to connect the
container to.</p></td>
        </tr>
        <tr>
          <td><code>stream_output</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If set, stream output from the container to local standard output.</p></td>
        </tr>
        <tr>
          <td><code>volumes</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>An optional list of volume mount strings in the format of
"local_path:container_path".</p></td>
        </tr>
        <tr>
          <td><code>memswap_limit</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[int, str]</code>
          </td>
          <td><p>Total memory (memory + swap), -1 to disable swap. Should only be
set if <code>mem_limit</code> is also set. If <code>mem_limit</code> is set, this defaults to
allowing the container to use as much swap as memory. For example, if
<code>mem_limit</code> is 300m and <code>memswap_limit</code> is not set, the container can use
600m in total of memory and swap.</p></td>
        </tr>
        <tr>
          <td><code>mem_limit</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[float, str]</code>
          </td>
          <td><p>Memory limit of the created container. Accepts float values to enforce
a limit in bytes or a string with a unit e.g. 100000b, 1000k, 128m, 1g.
If a string is given without a unit, bytes are assumed.</p></td>
        </tr>
        <tr>
          <td><code>privileged</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Give extended privileges to this container.</p></td>
        </tr>
    </tbody>
  </table>
      <h4 id="prefect.infrastructure.DockerContainer--connecting-to-a-locally-hosted-prefect-api">Connecting to a locally hosted Prefect API<a class="headerlink" href="#prefect.infrastructure.DockerContainer--connecting-to-a-locally-hosted-prefect-api" title="Permanent link">&para;</a></h4>
<p>If using a local API URL on Linux, we will update the network mode default to 'host'
to enable connectivity. If using another OS or an alternative network mode is used,
we will replace 'localhost' in the API URL with 'host.docker.internal'. Generally,
this will enable connectivity, but the API URL can be provided as an environment
variable to override inference in more complex use-cases.</p>
<p>Note, if using 'host.docker.internal' in the API URL on Linux, the API must be bound
to 0.0.0.0 or the Docker IP address to allow connectivity. On macOS, this is not
necessary and the API is connectable while bound to localhost.</p>


        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/docker.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DockerContainer</span><span class="p">(</span><span class="n">Infrastructure</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a command in a container.</span>

<span class="sd">    Requires a Docker Engine to be connectable. Docker settings will be retrieved from</span>
<span class="sd">    the environment.</span>

<span class="sd">    Click [here](https://docs.prefect.io/tutorials/docker/) to see a tutorial.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        auto_remove: If set, the container will be removed on completion. Otherwise,</span>
<span class="sd">            the container will remain after exit for inspection.</span>
<span class="sd">        command: A list of strings specifying the command to run in the container to</span>
<span class="sd">            start the flow run. In most cases you should not override this.</span>
<span class="sd">        env: Environment variables to set for the container.</span>
<span class="sd">        image: An optional string specifying the tag of a Docker image to use.</span>
<span class="sd">            Defaults to the Prefect image.</span>
<span class="sd">        image_pull_policy: Specifies if the image should be pulled. One of &#39;ALWAYS&#39;,</span>
<span class="sd">            &#39;NEVER&#39;, &#39;IF_NOT_PRESENT&#39;.</span>
<span class="sd">        image_registry: A `DockerRegistry` block containing credentials to use if `image` is stored in a private</span>
<span class="sd">            image registry.</span>
<span class="sd">        labels: An optional dictionary of labels, mapping name to value.</span>
<span class="sd">        name: An optional name for the container.</span>
<span class="sd">        network_mode: Set the network mode for the created container. Defaults to &#39;host&#39;</span>
<span class="sd">            if a local API url is detected, otherwise the Docker default of &#39;bridge&#39; is</span>
<span class="sd">            used. If &#39;networks&#39; is set, this cannot be set.</span>
<span class="sd">        networks: An optional list of strings specifying Docker networks to connect the</span>
<span class="sd">            container to.</span>
<span class="sd">        stream_output: If set, stream output from the container to local standard output.</span>
<span class="sd">        volumes: An optional list of volume mount strings in the format of</span>
<span class="sd">            &quot;local_path:container_path&quot;.</span>
<span class="sd">        memswap_limit: Total memory (memory + swap), -1 to disable swap. Should only be</span>
<span class="sd">            set if `mem_limit` is also set. If `mem_limit` is set, this defaults to</span>
<span class="sd">            allowing the container to use as much swap as memory. For example, if</span>
<span class="sd">            `mem_limit` is 300m and `memswap_limit` is not set, the container can use</span>
<span class="sd">            600m in total of memory and swap.</span>
<span class="sd">        mem_limit: Memory limit of the created container. Accepts float values to enforce</span>
<span class="sd">            a limit in bytes or a string with a unit e.g. 100000b, 1000k, 128m, 1g.</span>
<span class="sd">            If a string is given without a unit, bytes are assumed.</span>
<span class="sd">        privileged: Give extended privileges to this container.</span>

<span class="sd">    ## Connecting to a locally hosted Prefect API</span>

<span class="sd">    If using a local API URL on Linux, we will update the network mode default to &#39;host&#39;</span>
<span class="sd">    to enable connectivity. If using another OS or an alternative network mode is used,</span>
<span class="sd">    we will replace &#39;localhost&#39; in the API URL with &#39;host.docker.internal&#39;. Generally,</span>
<span class="sd">    this will enable connectivity, but the API URL can be provided as an environment</span>
<span class="sd">    variable to override inference in more complex use-cases.</span>

<span class="sd">    Note, if using &#39;host.docker.internal&#39; in the API URL on Linux, the API must be bound</span>
<span class="sd">    to 0.0.0.0 or the Docker IP address to allow connectivity. On macOS, this is not</span>
<span class="sd">    necessary and the API is connectable while bound to localhost.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;docker-container&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;docker-container&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The type of infrastructure.&quot;</span>
    <span class="p">)</span>
    <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_prefect_image_name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Tag of a Docker image to use. Defaults to the Prefect image.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_pull_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImagePullPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Specifies if the image should be pulled.&quot;</span>
    <span class="p">)</span>
    <span class="n">image_registry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DockerRegistry</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">networks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of strings specifying Docker networks to connect the container to.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">network_mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The network mode for the created container (e.g. host, bridge). If &#39;networks&#39; is set, this cannot be set.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">auto_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If set, the container will be removed on completion.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">volumes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A list of volume mount strings in the format of &quot;local_path:container_path&quot;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If set, the output will be streamed from the container to local standard output.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">memswap_limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Total memory (memory + swap), -1 to disable swap. Should only be &quot;</span>
            <span class="s2">&quot;set if `mem_limit` is also set. If `mem_limit` is set, this defaults to&quot;</span>
            <span class="s2">&quot;allowing the container to use as much swap as memory. For example, if &quot;</span>
            <span class="s2">&quot;`mem_limit` is 300m and `memswap_limit` is not set, the container can use &quot;</span>
            <span class="s2">&quot;600m in total of memory and swap.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">mem_limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Memory limit of the created container. Accepts float values to enforce &quot;</span>
            <span class="s2">&quot;a limit in bytes or a string with a unit e.g. 100000b, 1000k, 128m, 1g. &quot;</span>
            <span class="s2">&quot;If a string is given without a unit, bytes are assumed.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">privileged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Give extended privileges to this container.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_block_type_name</span> <span class="o">=</span> <span class="s2">&quot;Docker Container&quot;</span>
    <span class="n">_logo_url</span> <span class="o">=</span> <span class="s2">&quot;https://images.ctfassets.net/gm98wzqotmnx/2IfXXfMq66mrzJBDFFCHTp/6d8f320d9e4fc4393f045673d61ab612/Moby-logo.png?h=250&quot;</span>
    <span class="n">_documentation_url</span> <span class="o">=</span> <span class="s2">&quot;https://docs.prefect.io/api-ref/prefect/infrastructure/#prefect.infrastructure.DockerContainer&quot;</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">convert_labels_to_docker_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">namespace</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">new_namespace</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">namespace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)))</span>
                <span class="n">new_labels</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_namespace</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_labels</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">new_labels</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;volumes&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check_volume_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">volumes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">volume</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid volume specification. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected format &#39;path:container_path&#39;, but got </span><span class="si">{</span><span class="n">volume</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">volumes</span>

    <span class="nd">@sync_compatible</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">anyio</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">TaskStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Docker container cannot be run with empty command.&quot;</span><span class="p">)</span>

        <span class="c1"># The `docker` library uses requests instead of an async http library so it must</span>
        <span class="c1"># be run in a thread to avoid blocking the event loop.</span>
        <span class="n">container</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_and_start_container</span><span class="p">)</span>
        <span class="n">container_pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_infrastructure_pid</span><span class="p">(</span><span class="n">container_id</span><span class="o">=</span><span class="n">container</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Mark as started and return the infrastructure id</span>
        <span class="k">if</span> <span class="n">task_status</span><span class="p">:</span>
            <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">(</span><span class="n">container_pid</span><span class="p">)</span>

        <span class="c1"># Monitor the container</span>
        <span class="n">container</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watch_container_safe</span><span class="p">,</span> <span class="n">container</span>
        <span class="p">)</span>

        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;State&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ExitCode&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DockerContainerResult</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">exit_code</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="n">container_pid</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infrastructure_pid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">grace_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
        <span class="n">base_url</span><span class="p">,</span> <span class="n">container_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_infrastructure_pid</span><span class="p">(</span><span class="n">infrastructure_pid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">base_url</span> <span class="o">!=</span> <span class="n">base_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InfrastructureNotAvailable</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to stop container </span><span class="si">{</span><span class="n">container_id</span><span class="si">!r}</span><span class="s2">: the current Docker API &quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;URL </span><span class="si">{</span><span class="n">docker_client</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">base_url</span><span class="si">!r}</span><span class="s2"> does not match the expected &quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;API base URL </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container_id</span><span class="o">=</span><span class="n">container_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InfrastructureNotFound</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to stop container </span><span class="si">{</span><span class="n">container_id</span><span class="si">!r}</span><span class="s2">: The container was not found.&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">container</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">grace_seconds</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: build and document a more sophisticated preview</span>
        <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_container_settings</span><span class="p">(</span><span class="n">docker_client</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">docker_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_infrastructure_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates a Docker infrastructure_pid string in the form of</span>
<span class="sd">        `&lt;docker_host_base_url&gt;:&lt;container_id&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">base_url</span>
        <span class="n">docker_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">container_id</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_parse_infrastructure_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infrastructure_pid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits a Docker infrastructure_pid into its component parts&quot;&quot;&quot;</span>

        <span class="c1"># base_url can contain `:` so we only want the last item of the split</span>
        <span class="n">base_url</span><span class="p">,</span> <span class="n">container_id</span> <span class="o">=</span> <span class="n">infrastructure_pid</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">container_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_container_settings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">docker_client</span><span class="p">:</span> <span class="s2">&quot;DockerClient&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">network_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_network_mode</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">network_mode</span><span class="o">=</span><span class="n">network_mode</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
            <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_variables</span><span class="p">(</span><span class="n">network_mode</span><span class="p">),</span>
            <span class="n">auto_remove</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_remove</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">CONTAINER_LABELS</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">},</span>
            <span class="n">extra_hosts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_extra_hosts</span><span class="p">(</span><span class="n">docker_client</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_container_name</span><span class="p">(),</span>
            <span class="n">volumes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span>
            <span class="n">mem_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mem_limit</span><span class="p">,</span>
            <span class="n">memswap_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">memswap_limit</span><span class="p">,</span>
            <span class="n">privileged</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">privileged</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_and_start_container</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Container&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_registry</span><span class="p">:</span>
            <span class="c1"># If an image registry block was supplied, load an authenticated Docker</span>
            <span class="c1"># client from the block. Otherwise, use an unauthenticated client to</span>
            <span class="c1"># pull images from public registries.</span>
            <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_registry</span><span class="o">.</span><span class="n">get_docker_client</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>
        <span class="n">container_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_container_settings</span><span class="p">(</span><span class="n">docker_client</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_pull_image</span><span class="p">(</span><span class="n">docker_client</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pulling image </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="si">!r}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pull_image</span><span class="p">(</span><span class="n">docker_client</span><span class="p">)</span>

        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_container</span><span class="p">(</span><span class="n">docker_client</span><span class="p">,</span> <span class="o">**</span><span class="n">container_settings</span><span class="p">)</span>

        <span class="c1"># Add additional networks after the container is created; only one network can</span>
        <span class="c1"># be attached at creation time</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">network_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">network_name</span><span class="p">)</span>
                <span class="n">network</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>

        <span class="c1"># Start the container</span>
        <span class="n">container</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">docker_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">container</span>

    <span class="k">def</span> <span class="nf">_get_image_and_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">parse_image_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_determine_image_pull_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImagePullPolicy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the appropriate image pull policy.</span>

<span class="sd">        1. If they specified an image pull policy, use that.</span>

<span class="sd">        2. If they did not specify an image pull policy and gave us</span>
<span class="sd">           the &quot;latest&quot; tag, use ImagePullPolicy.always.</span>

<span class="sd">        3. If they did not specify an image pull policy and did not</span>
<span class="sd">           specify a tag, use ImagePullPolicy.always.</span>

<span class="sd">        4. If they did not specify an image pull policy and gave us</span>
<span class="sd">           a tag other than &quot;latest&quot;, use ImagePullPolicy.if_not_present.</span>

<span class="sd">        This logic matches the behavior of Kubernetes.</span>
<span class="sd">        See:https://kubernetes.io/docs/concepts/containers/images/#imagepullpolicy-defaulting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_pull_policy</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_image_and_tag</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;latest&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ImagePullPolicy</span><span class="o">.</span><span class="n">ALWAYS</span>
            <span class="k">return</span> <span class="n">ImagePullPolicy</span><span class="o">.</span><span class="n">IF_NOT_PRESENT</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_pull_policy</span>

    <span class="k">def</span> <span class="nf">_get_network_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># User&#39;s value takes precedence; this may collide with the incompatible options</span>
        <span class="c1"># mentioned below.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s2">&quot;linux&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_mode</span> <span class="o">==</span> <span class="s2">&quot;host&quot;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_mode</span><span class="si">!r}</span><span class="s2"> network mode is not supported on platform &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="si">!r}</span><span class="s2"> and may not work as intended.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_mode</span>

        <span class="c1"># Network mode is not compatible with networks or ports (we do not support ports</span>
        <span class="c1"># yet though)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check for a local API connection</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PREFECT_API_URL&quot;</span><span class="p">,</span> <span class="n">PREFECT_API_URL</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">api_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">api_url</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to parse host from API URL </span><span class="si">{</span><span class="n">api_url</span><span class="si">!r}</span><span class="s2"> with exception: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="se">\n</span><span class="s2">The network mode will not be inferred.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">host</span> <span class="o">=</span> <span class="n">netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># If using a locally hosted API, use a host network on linux</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;127.0.0.1&quot;</span> <span class="ow">or</span> <span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;host&quot;</span>

        <span class="c1"># Default to unset</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_should_pull_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docker_client</span><span class="p">:</span> <span class="s2">&quot;DockerClient&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decide whether we need to pull the Docker image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_pull_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_image_pull_policy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">image_pull_policy</span> <span class="ow">is</span> <span class="n">ImagePullPolicy</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">image_pull_policy</span> <span class="ow">is</span> <span class="n">ImagePullPolicy</span><span class="o">.</span><span class="n">NEVER</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">image_pull_policy</span> <span class="ow">is</span> <span class="n">ImagePullPolicy</span><span class="o">.</span><span class="n">IF_NOT_PRESENT</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># NOTE: images.get() wants the tag included with the image</span>
                <span class="c1"># name, while images.pull() wants them split.</span>
                <span class="n">docker_client</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ImageNotFound</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find Docker image locally: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_pull_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docker_client</span><span class="p">:</span> <span class="s2">&quot;DockerClient&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull the image we&#39;re going to use to create the container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_image_and_tag</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docker_client</span><span class="p">:</span> <span class="s2">&quot;DockerClient&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Container&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a docker container with retries on name conflicts.</span>

<span class="sd">        If the container already exists with the given name, an incremented index is</span>
<span class="sd">        added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the container with retries on name conflicts (with an incremented idx)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">container</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">original_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">container</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">docker.errors</span> <span class="kn">import</span> <span class="n">APIError</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">display_name</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s2">&quot;with auto-generated name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating Docker container </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="n">container</span> <span class="o">=</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Conflict&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;container name&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Docker container name </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> already exists; &quot;</span>
                        <span class="s2">&quot;retrying...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Docker container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> has status </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">container</span>

    <span class="k">def</span> <span class="nf">_watch_container_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="s2">&quot;Container&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Container&quot;</span><span class="p">:</span>
        <span class="c1"># Monitor the container capturing the latest snapshot while capturing</span>
        <span class="c1"># not found errors</span>
        <span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">latest_container</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_watch_container</span><span class="p">(</span><span class="n">docker_client</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="n">container</span> <span class="o">=</span> <span class="n">latest_container</span>
        <span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="c1"># The container was removed during watching</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Docker container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> was removed before we could wait &quot;</span>
                <span class="s2">&quot;for its completion.&quot;</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">docker_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">container</span>

    <span class="k">def</span> <span class="nf">_watch_container</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">docker_client</span><span class="p">:</span> <span class="s2">&quot;DockerClient&quot;</span><span class="p">,</span> <span class="n">container_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Container&quot;</span><span class="p">]:</span>
        <span class="n">container</span><span class="p">:</span> <span class="s2">&quot;Container&quot;</span> <span class="o">=</span> <span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container_id</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Docker container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> has status </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">container</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_output</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">logs</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">log</span><span class="p">:</span> <span class="nb">bytes</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;marked for removal&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Docker container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> was marked for removal before &quot;</span>
                        <span class="s2">&quot;logs could be retrieved. Output will not be streamed. &quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;An unexpected Docker API error occured while streaming output &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;from container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

            <span class="n">container</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Docker container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> has status </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">yield</span> <span class="n">container</span>

        <span class="n">container</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Docker container </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> has status </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">status</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">yield</span> <span class="n">container</span>

    <span class="k">def</span> <span class="nf">_get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="c1"># Silence warnings due to use of deprecated methods within dockerpy</span>
                <span class="c1"># See https://github.com/docker/docker-py/pull/2931</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;distutils Version classes are deprecated.*&quot;</span><span class="p">,</span>
                    <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">docker_client</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DockerException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect to Docker.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">return</span> <span class="n">docker_client</span>

    <span class="k">def</span> <span class="nf">_get_container_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a container name to match the configured name, ensuring it is Docker</span>
<span class="sd">        compatible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Must match `/?[a-zA-Z0-9][a-zA-Z0-9_.-]+` in the end</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">slugify</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">lowercase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="c1"># Docker does not limit length but URL limits apply eventually so</span>
                <span class="c1"># limit the length for safety</span>
                <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
                <span class="c1"># Docker allows these characters for container names</span>
                <span class="n">regex_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_.-]+&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span>
                <span class="c1"># Docker does not allow leading underscore, dash, or period</span>
                <span class="s2">&quot;_-.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Docker does not allow 0 character names so cast to null if the name is</span>
            <span class="c1"># empty after slufification</span>
            <span class="ow">or</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_extra_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docker_client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A host.docker.internal -&gt; host-gateway mapping is necessary for communicating</span>
<span class="sd">        with the API on Linux machines. Docker Desktop on macOS will automatically</span>
<span class="sd">        already have this mapping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="c1"># Do not warn if the user has specified a host manually that does not use</span>
            <span class="c1"># a local address</span>
            <span class="s2">&quot;PREFECT_API_URL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
            <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="s2">&quot;.*(localhost)|(127.0.0.1)|(host.docker.internal).*&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PREFECT_API_URL&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">user_version</span> <span class="o">=</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">docker_client</span><span class="o">.</span><span class="n">version</span><span class="p">()[</span><span class="s2">&quot;Version&quot;</span><span class="p">])</span>
            <span class="n">required_version</span> <span class="o">=</span> <span class="n">packaging</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;20.10.0&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">user_version</span> <span class="o">&lt;</span> <span class="n">required_version</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;`host.docker.internal` could not be automatically resolved to your &quot;</span>
                    <span class="s2">&quot;local ip address. This feature is not supported on Docker Engine &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">user_version</span><span class="si">}</span><span class="s2">, upgrade to v</span><span class="si">{</span><span class="n">required_version</span><span class="si">}</span><span class="s2">+ if you &quot;</span>
                    <span class="s2">&quot;encounter issues.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Compatibility for linux -- https://github.com/docker/cli/issues/2290</span>
                <span class="c1"># Only supported by Docker v20.10.0+ which is our minimum recommend version</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;host.docker.internal&quot;</span><span class="p">:</span> <span class="s2">&quot;host-gateway&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_environment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_mode</span><span class="p">):</span>
        <span class="c1"># If the API URL has been set by the base environment rather than the by the</span>
        <span class="c1"># user, update the value to ensure connectivity when using a bridge network by</span>
        <span class="c1"># updating local connections to use the docker internal host unless the</span>
        <span class="c1"># network mode is &quot;host&quot; where localhost is available already.</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_environment</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;PREFECT_API_URL&quot;</span> <span class="ow">in</span> <span class="n">env</span>
            <span class="ow">and</span> <span class="s2">&quot;PREFECT_API_URL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
            <span class="ow">and</span> <span class="n">network_mode</span> <span class="o">!=</span> <span class="s2">&quot;host&quot;</span>
        <span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PREFECT_API_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PREFECT_API_URL&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;host.docker.internal&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;host.docker.internal&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Drop null values allowing users to &quot;unset&quot; variables</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.DockerContainerResult" class="doc doc-heading">
        <code>DockerContainerResult</code>


<a href="#prefect.infrastructure.DockerContainerResult" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="prefect.infrastructure.base.InfrastructureResult">InfrastructureResult</span></code></p>

  
      <p>Contains information about a completed Docker container</p>


        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/docker.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DockerContainerResult</span><span class="p">(</span><span class="n">InfrastructureResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains information about a completed Docker container&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.Infrastructure" class="doc doc-heading">
        <code>Infrastructure</code>


<a href="#prefect.infrastructure.Infrastructure" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="prefect.blocks.core.Block" href="../blocks/core/#prefect.blocks.core.Block">Block</a></code>, <code>abc.<span title="abc.ABC">ABC</span></code></p>



        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/base.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Infrastructure</span><span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">_block_schema_capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run-infrastructure&quot;</span><span class="p">]</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>

    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Environment&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Environment variables to set in the configured infrastructure.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Labels applied to the infrastructure for metadata purposes.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name applied to the infrastructure for identification.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The command to run in the infrastructure.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_status</span><span class="p">:</span> <span class="n">anyio</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">TaskStatus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InfrastructureResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the infrastructure.</span>

<span class="sd">        If provided a `task_status`, the status will be reported as started when the</span>
<span class="sd">        infrastructure is successfully created. The status return value will be an</span>
<span class="sd">        identifier for the infrastructure.</span>

<span class="sd">        The call will then monitor the created infrastructure, returning a result at</span>
<span class="sd">        the end containing a status code indicating if the infrastructure exited cleanly</span>
<span class="sd">        or encountered an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: implementations should include `sync_compatible`</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        View a preview of the infrastructure that would be run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prefect.infrastructure.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_base_environment</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Environment variables that should be passed to all created infrastructure.</span>

<span class="sd">        These values should be overridable with the `env` field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_current_settings</span><span class="p">()</span><span class="o">.</span><span class="n">to_environment_variables</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_for_flow_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">flow_run</span><span class="p">:</span> <span class="s2">&quot;FlowRun&quot;</span><span class="p">,</span>
        <span class="n">deployment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Deployment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Flow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an infrastructure block that is prepared to execute a flow run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">deployment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deployment_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_deployment_labels</span><span class="p">(</span><span class="n">deployment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deployment_labels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">flow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flow_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_labels</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flow_labels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="n">update</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_run_environment</span><span class="p">(</span><span class="n">flow_run</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">},</span>
                <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_run_labels</span><span class="p">(</span><span class="n">flow_run</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">deployment_labels</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">flow_labels</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_run_command</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_base_flow_run_command</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a command for a flow run job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;prefect.engine&quot;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_base_flow_run_labels</span><span class="p">(</span><span class="n">flow_run</span><span class="p">:</span> <span class="s2">&quot;FlowRun&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a dictionary of labels for a flow run job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;prefect.io/flow-run-id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="s2">&quot;prefect.io/flow-run-name&quot;</span><span class="p">:</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;prefect.io/version&quot;</span><span class="p">:</span> <span class="n">prefect</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_base_flow_run_environment</span><span class="p">(</span><span class="n">flow_run</span><span class="p">:</span> <span class="s2">&quot;FlowRun&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a dictionary of environment variables for a flow run job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">environment</span><span class="p">[</span><span class="s2">&quot;PREFECT__FLOW_RUN_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">return</span> <span class="n">environment</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_base_deployment_labels</span><span class="p">(</span><span class="n">deployment</span><span class="p">:</span> <span class="s2">&quot;Deployment&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;prefect.io/deployment-name&quot;</span><span class="p">:</span> <span class="n">deployment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">deployment</span><span class="o">.</span><span class="n">updated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">[</span><span class="s2">&quot;prefect.io/deployment-updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deployment</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">in_timezone</span><span class="p">(</span>
                <span class="s2">&quot;utc&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_iso8601_string</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">labels</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_base_flow_labels</span><span class="p">(</span><span class="n">flow</span><span class="p">:</span> <span class="s2">&quot;Flow&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;prefect.io/flow-name&quot;</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.base.Infrastructure.prepare_for_flow_run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prepare_for_flow_run</span></code>

<a href="#prefect.infrastructure.base.Infrastructure.prepare_for_flow_run" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return an infrastructure block that is prepared to execute a flow run.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/base.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">prepare_for_flow_run</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
    <span class="n">flow_run</span><span class="p">:</span> <span class="s2">&quot;FlowRun&quot;</span><span class="p">,</span>
    <span class="n">deployment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Deployment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">flow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Flow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an infrastructure block that is prepared to execute a flow run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">deployment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deployment_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_deployment_labels</span><span class="p">(</span><span class="n">deployment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deployment_labels</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">flow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flow_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_labels</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flow_labels</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
        <span class="n">update</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_run_environment</span><span class="p">(</span><span class="n">flow_run</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">},</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_run_labels</span><span class="p">(</span><span class="n">flow_run</span><span class="p">),</span>
                <span class="o">**</span><span class="n">deployment_labels</span><span class="p">,</span>
                <span class="o">**</span><span class="n">flow_labels</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">flow_run</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_flow_run_command</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.base.Infrastructure.preview" class="doc doc-heading">
<code class="highlight language-python"><span class="n">preview</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#prefect.infrastructure.base.Infrastructure.preview" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>View a preview of the infrastructure that would be run.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/base.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View a preview of the infrastructure that would be run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.base.Infrastructure.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#prefect.infrastructure.base.Infrastructure.run" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Run the infrastructure.</p>
<p>If provided a <code>task_status</code>, the status will be reported as started when the
infrastructure is successfully created. The status return value will be an
identifier for the infrastructure.</p>
<p>The call will then monitor the created infrastructure, returning a result at
the end containing a status code indicating if the infrastructure exited cleanly
or encountered an error.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/base.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">task_status</span><span class="p">:</span> <span class="n">anyio</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">TaskStatus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InfrastructureResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the infrastructure.</span>

<span class="sd">    If provided a `task_status`, the status will be reported as started when the</span>
<span class="sd">    infrastructure is successfully created. The status return value will be an</span>
<span class="sd">    identifier for the infrastructure.</span>

<span class="sd">    The call will then monitor the created infrastructure, returning a result at</span>
<span class="sd">    the end containing a status code indicating if the infrastructure exited cleanly</span>
<span class="sd">    or encountered an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.KubernetesClusterConfig" class="doc doc-heading">
        <code>KubernetesClusterConfig</code>


<a href="#prefect.infrastructure.KubernetesClusterConfig" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="prefect.blocks.core.Block" href="../blocks/core/#prefect.blocks.core.Block">Block</a></code></p>

  
      <p>Stores configuration for interaction with Kubernetes clusters.</p>
<p>See <code>from_file</code> for creation.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span></code>
          </td>
          <td><p>The entire loaded YAML contents of a kubectl config file</p></td>
        </tr>
        <tr>
          <td><code>context_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the kubectl context to use</p></td>
        </tr>
    </tbody>
  </table>

<details class="example">
  <summary>Example</summary>
  <p>Load a saved Kubernetes cluster config:
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">prefect.blocks.kubernetes</span> <span class="kn">import</span> <span class="n">KubernetesClusterConfig</span>

<span class="n">cluster_config_block</span> <span class="o">=</span> <span class="n">KubernetesClusterConfig</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;BLOCK_NAME&quot;</span><span class="p">)</span>
</code></pre></div></p>
</details>

        <details class="quote">
          <summary>Source code in <code>prefect/blocks/kubernetes.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">KubernetesClusterConfig</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores configuration for interaction with Kubernetes clusters.</span>

<span class="sd">    See `from_file` for creation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config: The entire loaded YAML contents of a kubectl config file</span>
<span class="sd">        context_name: The name of the kubectl context to use</span>

<span class="sd">    Example:</span>
<span class="sd">        Load a saved Kubernetes cluster config:</span>
<span class="sd">        ```python</span>
<span class="sd">        from prefect.blocks.kubernetes import KubernetesClusterConfig</span>

<span class="sd">        cluster_config_block = KubernetesClusterConfig.load(&quot;BLOCK_NAME&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_block_type_name</span> <span class="o">=</span> <span class="s2">&quot;Kubernetes Cluster Config&quot;</span>
    <span class="n">_logo_url</span> <span class="o">=</span> <span class="s2">&quot;https://images.ctfassets.net/gm98wzqotmnx/1zrSeY8DZ1MJZs2BAyyyGk/20445025358491b8b72600b8f996125b/Kubernetes_logo_without_workmark.svg.png?h=250&quot;</span>
    <span class="n">_documentation_url</span> <span class="o">=</span> <span class="s2">&quot;https://docs.prefect.io/api-ref/prefect/blocks/kubernetes/#prefect.blocks.kubernetes.KubernetesClusterConfig&quot;</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The entire contents of a kubectl config file.&quot;</span>
    <span class="p">)</span>
    <span class="n">context_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the kubectl context to use.&quot;</span>
    <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">context_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a cluster config from the a Kubernetes config file.</span>

<span class="sd">        By default, the current context in the default Kubernetes config file will be</span>
<span class="sd">        used.</span>

<span class="sd">        An alternative file or context may be specified.</span>

<span class="sd">        The entire config file will be loaded and stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kube_config</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kube_config</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="n">kube_config</span><span class="o">.</span><span class="n">KUBE_CONFIG_DEFAULT_LOCATION</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="c1"># Determine the context</span>
        <span class="n">existing_contexts</span><span class="p">,</span> <span class="n">current_context</span> <span class="o">=</span> <span class="n">kube_config</span><span class="o">.</span><span class="n">list_kube_config_contexts</span><span class="p">(</span>
            <span class="n">config_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">context_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">existing_contexts</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">context_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Context </span><span class="si">{</span><span class="n">context_name</span><span class="si">!r}</span><span class="s2"> not found. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Specify one of: </span><span class="si">{</span><span class="n">listrepr</span><span class="p">(</span><span class="n">context_names</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context_name</span> <span class="o">=</span> <span class="n">current_context</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="c1"># Load the entire config file</span>
        <span class="n">config_file_contents</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_file_contents</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">context_name</span><span class="o">=</span><span class="n">context_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_api_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ApiClient&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a Kubernetes API client for this cluster config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kube_config</span><span class="o">.</span><span class="n">new_client_from_config_dict</span><span class="p">(</span>
            <span class="n">config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activates this cluster configuration by loading the configuration into the</span>
<span class="sd">        Kubernetes Python client. After calling this, Kubernetes API clients can use</span>
<span class="sd">        this config&#39;s context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kube_config</span><span class="o">.</span><span class="n">load_kube_config_from_dict</span><span class="p">(</span>
            <span class="n">config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_name</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="prefect.blocks.kubernetes.KubernetesClusterConfig.configure_client" class="doc doc-heading">
<code class="highlight language-python"><span class="n">configure_client</span></code>

<a href="#prefect.blocks.kubernetes.KubernetesClusterConfig.configure_client" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Activates this cluster configuration by loading the configuration into the
Kubernetes Python client. After calling this, Kubernetes API clients can use
this config's context.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/blocks/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">configure_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Activates this cluster configuration by loading the configuration into the</span>
<span class="sd">    Kubernetes Python client. After calling this, Kubernetes API clients can use</span>
<span class="sd">    this config&#39;s context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kube_config</span><span class="o">.</span><span class="n">load_kube_config_from_dict</span><span class="p">(</span>
        <span class="n">config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_name</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.blocks.kubernetes.KubernetesClusterConfig.from_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">from_file</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#prefect.blocks.kubernetes.KubernetesClusterConfig.from_file" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Create a cluster config from the a Kubernetes config file.</p>
<p>By default, the current context in the default Kubernetes config file will be
used.</p>
<p>An alternative file or context may be specified.</p>
<p>The entire config file will be loaded and stored.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/blocks/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Self</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">context_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a cluster config from the a Kubernetes config file.</span>

<span class="sd">    By default, the current context in the default Kubernetes config file will be</span>
<span class="sd">    used.</span>

<span class="sd">    An alternative file or context may be specified.</span>

<span class="sd">    The entire config file will be loaded and stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kube_config</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kube_config</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="n">kube_config</span><span class="o">.</span><span class="n">KUBE_CONFIG_DEFAULT_LOCATION</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="c1"># Determine the context</span>
    <span class="n">existing_contexts</span><span class="p">,</span> <span class="n">current_context</span> <span class="o">=</span> <span class="n">kube_config</span><span class="o">.</span><span class="n">list_kube_config_contexts</span><span class="p">(</span>
        <span class="n">config_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">context_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">existing_contexts</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">context_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Context </span><span class="si">{</span><span class="n">context_name</span><span class="si">!r}</span><span class="s2"> not found. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Specify one of: </span><span class="si">{</span><span class="n">listrepr</span><span class="p">(</span><span class="n">context_names</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context_name</span> <span class="o">=</span> <span class="n">current_context</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="c1"># Load the entire config file</span>
    <span class="n">config_file_contents</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_file_contents</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">context_name</span><span class="o">=</span><span class="n">context_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.blocks.kubernetes.KubernetesClusterConfig.get_api_client" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_api_client</span></code>

<a href="#prefect.blocks.kubernetes.KubernetesClusterConfig.get_api_client" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns a Kubernetes API client for this cluster config.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/blocks/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_api_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ApiClient&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a Kubernetes API client for this cluster config.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kube_config</span><span class="o">.</span><span class="n">new_client_from_config_dict</span><span class="p">(</span>
        <span class="n">config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_name</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.KubernetesJob" class="doc doc-heading">
        <code>KubernetesJob</code>


<a href="#prefect.infrastructure.KubernetesJob" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="prefect.infrastructure.base.Infrastructure" href="#prefect.infrastructure.Infrastructure">Infrastructure</a></code></p>

  
      <p>Runs a command as a Kubernetes Job.</p>
<p>Click <a href="https://medium.com/the-prefect-blog/how-to-use-kubernetes-with-prefect-419b2e8b8cb2/">here</a> to see a tutorial.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cluster_config</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="prefect.blocks.kubernetes.KubernetesClusterConfig" href="../blocks/kubernetes/#prefect.blocks.kubernetes.KubernetesClusterConfig">KubernetesClusterConfig</a>]</code>
          </td>
          <td><p>An optional Kubernetes cluster config to use for this job.</p></td>
        </tr>
        <tr>
          <td><code>command</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="prefect.blocks.kubernetes.KubernetesClusterConfig" href="../blocks/kubernetes/#prefect.blocks.kubernetes.KubernetesClusterConfig">KubernetesClusterConfig</a>]</code>
          </td>
          <td><p>A list of strings specifying the command to run in the container to
start the flow run. In most cases you should not override this.</p></td>
        </tr>
        <tr>
          <td><code>customizations</code></td>
          <td>
                <code><span title="prefect.utilities.pydantic.JsonPatch">JsonPatch</span></code>
          </td>
          <td><p>A list of JSON 6902 patches to apply to the base Job manifest.</p></td>
        </tr>
        <tr>
          <td><code>env</code></td>
          <td>
                <code><span title="prefect.utilities.pydantic.JsonPatch">JsonPatch</span></code>
          </td>
          <td><p>Environment variables to set for the container.</p></td>
        </tr>
        <tr>
          <td><code>finished_job_ttl</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>The number of seconds to retain jobs after completion. If set, finished jobs will
be cleaned up by Kubernetes after the given delay. If None (default), jobs will need to be
manually removed.</p></td>
        </tr>
        <tr>
          <td><code>image</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td><p>An optional string specifying the image reference of a container image
to use for the job, for example, docker.io/prefecthq/prefect:2-latest. The
behavior is as described in https://kubernetes.io/docs/concepts/containers/images/#image-names.
Defaults to the Prefect image.</p></td>
        </tr>
        <tr>
          <td><code>image_pull_policy</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="prefect.infrastructure.kubernetes.KubernetesImagePullPolicy">KubernetesImagePullPolicy</span>]</code>
          </td>
          <td><p>The Kubernetes image pull policy to use for job containers.</p></td>
        </tr>
        <tr>
          <td><code>job</code></td>
          <td>
                <code><span title="prefect.infrastructure.kubernetes.KubernetesManifest">KubernetesManifest</span></code>
          </td>
          <td><p>The base manifest for the Kubernetes Job.</p></td>
        </tr>
        <tr>
          <td><code>job_watch_timeout_seconds</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Number of seconds to wait for each event emitted by the job before
timing out. Defaults to <code>None</code>, which means no timeout will be enforced
while waiting for each event in the job lifecycle.</p></td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>An optional dictionary of labels to add to the job.</p></td>
        </tr>
        <tr>
          <td><code>name</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>An optional name for the job.</p></td>
        </tr>
        <tr>
          <td><code>namespace</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td><p>An optional string signifying the Kubernetes namespace to use.</p></td>
        </tr>
        <tr>
          <td><code>pod_watch_timeout_seconds</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of seconds to watch for pod creation before timing out (default 60).</p></td>
        </tr>
        <tr>
          <td><code>service_account_name</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td><p>An optional string specifying which Kubernetes service account to use.</p></td>
        </tr>
        <tr>
          <td><code>stream_output</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If set, stream output from the job to local standard output.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/kubernetes.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">KubernetesJob</span><span class="p">(</span><span class="n">Infrastructure</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a command as a Kubernetes Job.</span>

<span class="sd">    Click [here](https://medium.com/the-prefect-blog/how-to-use-kubernetes-with-prefect-419b2e8b8cb2/) to see a tutorial.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        cluster_config: An optional Kubernetes cluster config to use for this job.</span>
<span class="sd">        command: A list of strings specifying the command to run in the container to</span>
<span class="sd">            start the flow run. In most cases you should not override this.</span>
<span class="sd">        customizations: A list of JSON 6902 patches to apply to the base Job manifest.</span>
<span class="sd">        env: Environment variables to set for the container.</span>
<span class="sd">        finished_job_ttl: The number of seconds to retain jobs after completion. If set, finished jobs will</span>
<span class="sd">            be cleaned up by Kubernetes after the given delay. If None (default), jobs will need to be</span>
<span class="sd">            manually removed.</span>
<span class="sd">        image: An optional string specifying the image reference of a container image</span>
<span class="sd">            to use for the job, for example, docker.io/prefecthq/prefect:2-latest. The</span>
<span class="sd">            behavior is as described in https://kubernetes.io/docs/concepts/containers/images/#image-names.</span>
<span class="sd">            Defaults to the Prefect image.</span>
<span class="sd">        image_pull_policy: The Kubernetes image pull policy to use for job containers.</span>
<span class="sd">        job: The base manifest for the Kubernetes Job.</span>
<span class="sd">        job_watch_timeout_seconds: Number of seconds to wait for each event emitted by the job before</span>
<span class="sd">            timing out. Defaults to `None`, which means no timeout will be enforced</span>
<span class="sd">            while waiting for each event in the job lifecycle.</span>
<span class="sd">        labels: An optional dictionary of labels to add to the job.</span>
<span class="sd">        name: An optional name for the job.</span>
<span class="sd">        namespace: An optional string signifying the Kubernetes namespace to use.</span>
<span class="sd">        pod_watch_timeout_seconds: Number of seconds to watch for pod creation before timing out (default 60).</span>
<span class="sd">        service_account_name: An optional string specifying which Kubernetes service account to use.</span>
<span class="sd">        stream_output: If set, stream output from the job to local standard output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_logo_url</span> <span class="o">=</span> <span class="s2">&quot;https://images.ctfassets.net/gm98wzqotmnx/1zrSeY8DZ1MJZs2BAyyyGk/20445025358491b8b72600b8f996125b/Kubernetes_logo_without_workmark.svg.png?h=250&quot;</span>
    <span class="n">_documentation_url</span> <span class="o">=</span> <span class="s2">&quot;https://docs.prefect.io/api-ref/prefect/infrastructure/#prefect.infrastructure.KubernetesJob&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;kubernetes-job&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;kubernetes-job&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The type of infrastructure.&quot;</span>
    <span class="p">)</span>
    <span class="c1"># shortcuts for the most common user-serviceable settings</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The image reference of a container image to use for the job, for example, `docker.io/prefecthq/prefect:2-latest`.&quot;</span>
            <span class="s2">&quot;The behavior is as described in the Kubernetes documentation and uses the latest version of Prefect by default, unless an image is already present in a provided job manifest.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The Kubernetes namespace to use for this job. Defaults to &#39;default&#39; &quot;</span>
            <span class="s2">&quot;unless a namespace is already present in a provided job manifest.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">service_account_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The Kubernetes service account to use for this job.&quot;</span>
    <span class="p">)</span>
    <span class="n">image_pull_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">KubernetesImagePullPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The Kubernetes image pull policy to use for job containers.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># connection to a cluster</span>
    <span class="n">cluster_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">KubernetesClusterConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The Kubernetes cluster config to use for this job.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># settings allowing full customization of the Job</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">KubernetesManifest</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">KubernetesJob</span><span class="o">.</span><span class="n">base_job_manifest</span><span class="p">(),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The base manifest for the Kubernetes Job.&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Base Job Manifest&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">customizations</span><span class="p">:</span> <span class="n">JsonPatch</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">JsonPatch</span><span class="p">([]),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of JSON 6902 patches to apply to the base Job manifest.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># controls the behavior of execution</span>
    <span class="n">job_watch_timeout_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Number of seconds to wait for each event emitted by the job before &quot;</span>
            <span class="s2">&quot;timing out. Defaults to `None`, which means no timeout will be enforced &quot;</span>
            <span class="s2">&quot;while waiting for each event in the job lifecycle.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">pod_watch_timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of seconds to watch for pod creation before timing out.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If set, output will be streamed from the job to local standard output.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">finished_job_ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The number of seconds to retain jobs after completion. If set, finished jobs will be cleaned up by Kubernetes after the given delay. If None (default), jobs will need to be manually removed.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># internal-use only right now</span>
    <span class="n">_api_dns_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replaces &#39;localhost&#39; in API URL</span>

    <span class="n">_block_type_name</span> <span class="o">=</span> <span class="s2">&quot;Kubernetes Job&quot;</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;job&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ensure_job_includes_all_required_components</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">KubernetesManifest</span><span class="p">):</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">JsonPatch</span><span class="o">.</span><span class="n">from_diff</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_job_manifest</span><span class="p">())</span>
        <span class="n">missing_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">patch</span> <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">missing_paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Job is missing required attributes at the following paths: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;job&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ensure_job_has_compatible_values</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">KubernetesManifest</span><span class="p">):</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">JsonPatch</span><span class="o">.</span><span class="n">from_diff</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_job_manifest</span><span class="p">())</span>
        <span class="n">incompatible</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">op</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> must have value </span><span class="si">{</span><span class="n">op</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">patch</span>
                <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">incompatible</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Job has incompatble values for the following attributes: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">incompatible</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;customizations&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cast_customizations_to_a_json_patch</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">JsonPatch</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonPatch</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonPatch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JsonPatch</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to parse customizations as JSON: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">. Please make sure that the provided value is a valid JSON string.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">default_namespace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job&quot;</span><span class="p">)</span>

        <span class="n">namespace</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">)</span>
        <span class="n">job_namespace</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;namespace&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">job</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_namespace</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">default_image</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job&quot;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
        <span class="n">job_image</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">job</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;template&quot;</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;containers&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_image</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_prefect_image_name</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="c1"># Support serialization of the &#39;JsonPatch&#39; type</span>
    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">json_encoders</span> <span class="o">=</span> <span class="p">{</span><span class="n">JsonPatch</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">patch</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;customizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customizations</span><span class="o">.</span><span class="n">patch</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">base_job_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesManifest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produces the bare minimum allowed Job manifest&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;batch/v1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;Job&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{}},</span>
            <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;parallelism&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;completions&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;restartPolicy&quot;</span><span class="p">:</span> <span class="s2">&quot;Never&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;containers&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;prefect-job&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="c1"># Note that we&#39;re using the yaml package to load both YAML and JSON files below.</span>
    <span class="c1"># This works because YAML is a strict superset of JSON:</span>
    <span class="c1">#</span>
    <span class="c1">#   &gt; The YAML 1.23 specification was published in 2009. Its primary focus was</span>
    <span class="c1">#   &gt; making YAML a strict superset of JSON. It also removed many of the problematic</span>
    <span class="c1">#   &gt; implicit typing recommendations.</span>
    <span class="c1">#</span>
    <span class="c1">#   https://yaml.org/spec/1.2.2/#12-yaml-history</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">job_from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesManifest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a Kubernetes Job manifest from a YAML or JSON file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">customize_from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonPatch</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load an RFC 6902 JSON patch from a YAML or JSON file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JsonPatch</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">))</span>

    <span class="nd">@sync_compatible</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">anyio</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">TaskStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesJobResult</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Kubernetes job cannot be run with empty command.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_kubernetes_library_client</span><span class="p">()</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_job</span><span class="p">()</span>
        <span class="n">job</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_job</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_infrastructure_pid</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="c1"># Indicate that the job has started</span>
        <span class="k">if</span> <span class="n">task_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="c1"># Monitor the job until completion</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_sync_in_worker_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watch_job</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">KubernetesJobResult</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infrastructure_pid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">grace_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_kubernetes_library_client</span><span class="p">()</span>
        <span class="n">job_cluster_uid</span><span class="p">,</span> <span class="n">job_namespace</span><span class="p">,</span> <span class="n">job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_infrastructure_pid</span><span class="p">(</span>
            <span class="n">infrastructure_pid</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_namespace</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InfrastructureNotAvailable</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to kill job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: The job is running in namespace &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_namespace</span><span class="si">!r}</span><span class="s2"> but this block is configured to use &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">current_cluster_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_uid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">job_cluster_uid</span> <span class="o">!=</span> <span class="n">current_cluster_uid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InfrastructureNotAvailable</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to kill job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: The job is running on another &quot;</span>
                <span class="s2">&quot;cluster.&quot;</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch_client</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">batch_client</span><span class="o">.</span><span class="n">delete_namespaced_job</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="n">job_namespace</span><span class="p">,</span>
                    <span class="n">grace_period_seconds</span><span class="o">=</span><span class="n">grace_seconds</span><span class="p">,</span>
                    <span class="c1"># Foreground propagation deletes dependent objects before deleting owner objects.</span>
                    <span class="c1"># This ensures that the pods are cleaned up before the job is marked as deleted.</span>
                    <span class="c1"># See: https://kubernetes.io/docs/concepts/architecture/garbage-collection/#foreground-deletion</span>
                    <span class="n">propagation_policy</span><span class="o">=</span><span class="s2">&quot;Foreground&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ApiException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InfrastructureNotFound</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to kill job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: The job was not found.&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_job</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">build_job</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesManifest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the Kubernetes Job Manifest&quot;&quot;&quot;</span>
        <span class="n">job_manifest</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
        <span class="n">job_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcut_customizations</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">job_manifest</span><span class="p">)</span>
        <span class="n">job_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customizations</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">job_manifest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job_manifest</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">get_batch_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="s2">&quot;BatchV1Api&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ApiClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">BatchV1Api</span><span class="p">(</span><span class="n">api_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">rest_client</span><span class="o">.</span><span class="n">pool_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="s2">&quot;CoreV1Api&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ApiClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">CoreV1Api</span><span class="p">(</span><span class="n">api_client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">rest_client</span><span class="o">.</span><span class="n">pool_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_infrastructure_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="s2">&quot;V1Job&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a Kubernetes infrastructure PID.</span>

<span class="sd">        The PID is in the format: &quot;&lt;cluster uid&gt;:&lt;namespace&gt;:&lt;job name&gt;&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cluster_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cluster_uid</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_uid</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">pid</span>

    <span class="k">def</span> <span class="nf">_parse_infrastructure_pid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">infrastructure_pid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a Kubernetes infrastructure PID into its component parts.</span>

<span class="sd">        Returns a cluster UID, namespace, and job name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cluster_uid</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">job_name</span> <span class="o">=</span> <span class="n">infrastructure_pid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cluster_uid</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">job_name</span>

    <span class="k">def</span> <span class="nf">_get_cluster_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a unique id for the current cluster being used.</span>

<span class="sd">        There is no real unique identifier for a cluster. However, the `kube-system`</span>
<span class="sd">        namespace is immutable and has a persistence UID that we use instead.</span>

<span class="sd">        PREFECT_KUBERNETES_CLUSTER_UID can be set in cases where the `kube-system`</span>
<span class="sd">        namespace cannot be read e.g. when a cluster role cannot be created. If set,</span>
<span class="sd">        this variable will be used and we will not attempt to read the `kube-system`</span>
<span class="sd">        namespace.</span>

<span class="sd">        See https://github.com/kubernetes/kubernetes/issues/44954</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default to an environment variable</span>
        <span class="n">env_cluster_uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PREFECT_KUBERNETES_CLUSTER_UID&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_cluster_uid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">env_cluster_uid</span>

        <span class="c1"># Read the UID from the cluster namespace</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_namespace</span><span class="p">(</span><span class="s2">&quot;kube-system&quot;</span><span class="p">)</span>
        <span class="n">cluster_uid</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">uid</span>

        <span class="k">return</span> <span class="n">cluster_uid</span>

    <span class="k">def</span> <span class="nf">_configure_kubernetes_library_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the correct kubernetes client configuration.</span>

<span class="sd">        WARNING: This action is not threadsafe and may override the configuration</span>
<span class="sd">                  specified by another `KubernetesJob` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Investigate returning a configured client so calls on other threads</span>
        <span class="c1">#       will not invalidate the config needed here</span>

        <span class="c1"># if a k8s cluster block is provided to the flow runner, use that</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_config</span><span class="o">.</span><span class="n">configure_client</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no block specified, try to load Kubernetes configuration within a cluster. If that doesn&#39;t</span>
            <span class="c1"># work, try to load the configuration from the local environment, allowing</span>
            <span class="c1"># any further ConfigExceptions to bubble up.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load_incluster_config</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ConfigException</span><span class="p">:</span>
                <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load_kube_config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_shortcut_customizations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonPatch</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produces the JSON 6902 patch for the most commonly used customizations, like</span>
<span class="sd">        image and namespace, which we offer as top-level parameters (with sensible</span>
<span class="sd">        default values)&quot;&quot;&quot;</span>
        <span class="n">shortcuts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/metadata/namespace&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/spec/template/spec/containers/0/image&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">shortcuts</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/metadata/labels/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_slugify_label_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;~1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slugify_label_value</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">shortcuts</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/spec/template/spec/containers/0/env/-&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_variables</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_pull_policy</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/spec/template/spec/containers/0/imagePullPolicy&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_pull_policy</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_account_name</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/spec/template/spec/serviceAccountName&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_account_name</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_job_ttl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/spec/ttlSecondsAfterFinished&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_job_ttl</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/spec/template/spec/containers/0/args&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/metadata/generateName&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slugify_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate name is required</span>
            <span class="n">shortcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/metadata/generateName&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;prefect-job-&quot;</span>
                    <span class="c1"># We generate a name using a hash of the primary job settings</span>
                    <span class="o">+</span> <span class="n">stable_hash</span><span class="p">(</span>
                        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                        <span class="o">*</span><span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">JsonPatch</span><span class="p">(</span><span class="n">shortcuts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;V1Job&quot;</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch_client</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">batch_client</span><span class="o">.</span><span class="n">read_namespaced_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ApiException</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">!r}</span><span class="s2"> was removed.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">job</span>

    <span class="k">def</span> <span class="nf">_get_job_pod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;V1Pod&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the first running pod for a job.&quot;&quot;&quot;</span>

        <span class="c1"># Wait until we find a running pod for the job</span>
        <span class="c1"># if `pod_watch_timeout_seconds` is None, no timeout will be enforced</span>
        <span class="n">watch</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">watch</span><span class="o">.</span><span class="n">Watch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: Starting watch for pod start...&quot;</span><span class="p">)</span>
        <span class="n">last_phase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">watch</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">list_namespaced_pod</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                <span class="n">label_selector</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;job-name=</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pod_watch_timeout_seconds</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">phase</span>
                <span class="k">if</span> <span class="n">phase</span> <span class="o">!=</span> <span class="n">last_phase</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: Pod has status </span><span class="si">{</span><span class="n">phase</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">phase</span> <span class="o">!=</span> <span class="s2">&quot;Pending&quot;</span><span class="p">:</span>
                    <span class="n">watch</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>

                <span class="n">last_phase</span> <span class="o">=</span> <span class="n">phase</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: Pod never started.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_watch_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Watch a job.</span>

<span class="sd">        Return the final status code of the first container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">pod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_job_pod</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pod</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_output</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_namespaced_pod_log</span><span class="p">(</span>
                    <span class="n">pod</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                    <span class="n">follow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">_preload_content</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">stream</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Error occurred while streaming logs - &quot;</span>
                        <span class="s2">&quot;Job will continue to run but logs will &quot;</span>
                        <span class="s2">&quot;no longer be streamed to stdout.&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: Starting watch for job completion&quot;</span><span class="p">)</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_watch_timeout_seconds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_watch_timeout_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">completed</span><span class="p">:</span>
            <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="k">if</span> <span class="n">deadline</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">deadline</span> <span class="ow">and</span> <span class="n">remaining_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: Job did not complete within &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;timeout of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_watch_timeout_seconds</span><span class="si">}</span><span class="s2">s.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="n">watch</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">watch</span><span class="o">.</span><span class="n">Watch</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch_client</span><span class="p">:</span>
                <span class="c1"># The kubernetes library will disable retries if the timeout kwarg is</span>
                <span class="c1"># present regardless of the value so we do not pass it unless given</span>
                <span class="c1"># https://github.com/kubernetes-client/python/blob/84f5fea2a3e4b161917aa597bf5e5a1d95e24f5a/kubernetes/base/watch/watch.py#LL160</span>
                <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;timeout_seconds&quot;</span><span class="p">:</span> <span class="n">remaining_time</span><span class="p">}</span> <span class="k">if</span> <span class="n">deadline</span> <span class="k">else</span> <span class="p">{}</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">watch</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">batch_client</span><span class="o">.</span><span class="n">list_namespaced_job</span><span class="p">,</span>
                    <span class="n">field_selector</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;metadata.name=</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">timeout_seconds</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">completion_time</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
                            <span class="c1"># Job failed, exit while loop and return pod exit code</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">!r}</span><span class="s2">: Job failed.&quot;</span><span class="p">)</span>
                        <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">watch</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                        <span class="k">break</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">pod_status</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">read_namespaced_pod_status</span><span class="p">(</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pod</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="n">first_container_status</span> <span class="o">=</span> <span class="n">pod_status</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">container_statuses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">first_container_status</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">terminated</span><span class="o">.</span><span class="n">exit_code</span>

    <span class="k">def</span> <span class="nf">_create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_manifest</span><span class="p">:</span> <span class="n">KubernetesManifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;V1Job&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a Kubernetes Job Manifest, create the Job on the configured Kubernetes</span>
<span class="sd">        cluster and return its name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch_client</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">batch_client</span><span class="o">.</span><span class="n">create_namespaced_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">job_manifest</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job</span>

    <span class="k">def</span> <span class="nf">_slugify_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slugify text for use as a name.</span>

<span class="sd">        Keeps only alphanumeric characters and dashes, and caps the length</span>
<span class="sd">        of the slug at 45 chars.</span>

<span class="sd">        The 45 character length allows room for the k8s utility</span>
<span class="sd">        &quot;generateName&quot; to generate a unique name from the slug while</span>
<span class="sd">        keeping the total length of a name below 63 characters, which is</span>
<span class="sd">        the limit for e.g. label names that follow RFC 1123 (hostnames) and</span>
<span class="sd">        RFC 1035 (domain names).</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the job</span>

<span class="sd">        Returns:</span>
<span class="sd">            the slugified job name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slug</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>  <span class="c1"># Leave enough space for generateName</span>
            <span class="n">regex_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9-]+&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># TODO: Handle the case that the name is an empty string after being</span>
        <span class="c1"># slugified.</span>

        <span class="k">return</span> <span class="n">slug</span>

    <span class="k">def</span> <span class="nf">_slugify_label_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slugify text for use as a label key.</span>

<span class="sd">        Keys are composed of an optional prefix and name, separated by a slash (/).</span>

<span class="sd">        Keeps only alphanumeric characters, dashes, underscores, and periods.</span>
<span class="sd">        Limits the length of the label prefix to 253 characters.</span>
<span class="sd">        Limits the length of the label name to 63 characters.</span>

<span class="sd">        See https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#syntax-and-character-set</span>

<span class="sd">        Args:</span>
<span class="sd">            key: The label key</span>

<span class="sd">        Returns:</span>
<span class="sd">            The slugified label key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">key</span>

        <span class="n">name_slug</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">slugify</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span> <span class="n">regex_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9-_.]+&quot;</span><span class="p">,)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                <span class="s2">&quot;_-.&quot;</span>  <span class="c1"># Must start or end with alphanumeric characters</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="n">name</span>
        <span class="p">)</span>
        <span class="c1"># Fallback to the original if we end up with an empty slug, this will allow</span>
        <span class="c1"># Kubernetes to throw the validation error</span>

        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">prefix_slug</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">slugify</span><span class="p">(</span>
                    <span class="n">prefix</span><span class="p">,</span>
                    <span class="n">max_length</span><span class="o">=</span><span class="mi">253</span><span class="p">,</span>
                    <span class="n">regex_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9-\.]+&quot;</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                    <span class="s2">&quot;_-.&quot;</span>
                <span class="p">)</span>  <span class="c1"># Must start or end with alphanumeric characters</span>
                <span class="ow">or</span> <span class="n">prefix</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix_slug</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name_slug</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">name_slug</span>

    <span class="k">def</span> <span class="nf">_slugify_label_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slugify text for use as a label value.</span>

<span class="sd">        Keeps only alphanumeric characters, dashes, underscores, and periods.</span>
<span class="sd">        Limits the total length of label text to below 63 characters.</span>

<span class="sd">        See https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#syntax-and-character-set</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The text for the label</span>

<span class="sd">        Returns:</span>
<span class="sd">            The slugified value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slug</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">slugify</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span> <span class="n">regex_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9-_\.]+&quot;</span><span class="p">,)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                <span class="s2">&quot;_-.&quot;</span>  <span class="c1"># Must start or end with alphanumeric characters</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="n">value</span>
        <span class="p">)</span>
        <span class="c1"># Fallback to the original if we end up with an empty slug, this will allow</span>
        <span class="c1"># Kubernetes to throw the validation error</span>

        <span class="k">return</span> <span class="n">slug</span>

    <span class="k">def</span> <span class="nf">_get_environment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If the API URL has been set by the base environment rather than the by the</span>
        <span class="c1"># user, update the value to ensure connectivity when using a bridge network by</span>
        <span class="c1"># updating local connections to use the internal host</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_environment</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;PREFECT_API_URL&quot;</span> <span class="ow">in</span> <span class="n">env</span>
            <span class="ow">and</span> <span class="s2">&quot;PREFECT_API_URL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_dns_name</span>
        <span class="p">):</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PREFECT_API_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PREFECT_API_URL&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_dns_name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_dns_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Drop null values allowing users to &quot;unset&quot; variables</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.kubernetes.KubernetesJob.base_job_manifest" class="doc doc-heading">
<code class="highlight language-python"><span class="n">base_job_manifest</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#prefect.infrastructure.kubernetes.KubernetesJob.base_job_manifest" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Produces the bare minimum allowed Job manifest</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">base_job_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesManifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produces the bare minimum allowed Job manifest&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;batch/v1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;Job&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{}},</span>
        <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;parallelism&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;completions&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;restartPolicy&quot;</span><span class="p">:</span> <span class="s2">&quot;Never&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;containers&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;prefect-job&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.kubernetes.KubernetesJob.build_job" class="doc doc-heading">
<code class="highlight language-python"><span class="n">build_job</span></code>

<a href="#prefect.infrastructure.kubernetes.KubernetesJob.build_job" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Builds the Kubernetes Job Manifest</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_job</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesManifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builds the Kubernetes Job Manifest&quot;&quot;&quot;</span>
    <span class="n">job_manifest</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
    <span class="n">job_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shortcut_customizations</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">job_manifest</span><span class="p">)</span>
    <span class="n">job_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customizations</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">job_manifest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">job_manifest</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.kubernetes.KubernetesJob.customize_from_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">customize_from_file</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#prefect.infrastructure.kubernetes.KubernetesJob.customize_from_file" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Load an RFC 6902 JSON patch from a YAML or JSON file.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">customize_from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JsonPatch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load an RFC 6902 JSON patch from a YAML or JSON file.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JsonPatch</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="prefect.infrastructure.kubernetes.KubernetesJob.job_from_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">job_from_file</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#prefect.infrastructure.kubernetes.KubernetesJob.job_from_file" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Load a Kubernetes Job manifest from a YAML or JSON file.</p>

      <details class="quote">
        <summary>Source code in <code>prefect/infrastructure/kubernetes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">job_from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KubernetesManifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a Kubernetes Job manifest from a YAML or JSON file.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.KubernetesJobResult" class="doc doc-heading">
        <code>KubernetesJobResult</code>


<a href="#prefect.infrastructure.KubernetesJobResult" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="prefect.infrastructure.base.InfrastructureResult">InfrastructureResult</span></code></p>

  
      <p>Contains information about the final state of a completed Kubernetes Job</p>


        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/kubernetes.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">KubernetesJobResult</span><span class="p">(</span><span class="n">InfrastructureResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains information about the final state of a completed Kubernetes Job&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.Process" class="doc doc-heading">
        <code>Process</code>


<a href="#prefect.infrastructure.Process" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="prefect.infrastructure.base.Infrastructure" href="#prefect.infrastructure.Infrastructure">Infrastructure</a></code></p>

  
      <p>Run a command in a new process.</p>
<p>Current environment variables and Prefect settings will be included in the created
process. Configured environment variables will override any current environment
variables.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>command</code></td>
          <td>
          </td>
          <td><p>A list of strings specifying the command to run in the container to
start the flow run. In most cases you should not override this.</p></td>
        </tr>
        <tr>
          <td><code>env</code></td>
          <td>
          </td>
          <td><p>Environment variables to set for the new process.</p></td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
          </td>
          <td><p>Labels for the process. Labels are for metadata purposes only and
cannot be attached to the process itself.</p></td>
        </tr>
        <tr>
          <td><code>name</code></td>
          <td>
          </td>
          <td><p>A name for the process. For display purposes only.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/process.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Process</span><span class="p">(</span><span class="n">Infrastructure</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a command in a new process.</span>

<span class="sd">    Current environment variables and Prefect settings will be included in the created</span>
<span class="sd">    process. Configured environment variables will override any current environment</span>
<span class="sd">    variables.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        command: A list of strings specifying the command to run in the container to</span>
<span class="sd">            start the flow run. In most cases you should not override this.</span>
<span class="sd">        env: Environment variables to set for the new process.</span>
<span class="sd">        labels: Labels for the process. Labels are for metadata purposes only and</span>
<span class="sd">            cannot be attached to the process itself.</span>
<span class="sd">        name: A name for the process. For display purposes only.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_logo_url</span> <span class="o">=</span> <span class="s2">&quot;https://images.ctfassets.net/gm98wzqotmnx/39WQhVu4JK40rZWltGqhuC/d15be6189a0cb95949a6b43df00dcb9b/image5.png?h=250&quot;</span>
    <span class="n">_documentation_url</span> <span class="o">=</span> <span class="s2">&quot;https://docs.prefect.io/concepts/infrastructure/#process&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The type of infrastructure.&quot;</span>
    <span class="p">)</span>
    <span class="n">stream_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If set, output will be streamed from the process to local standard output.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">working_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If set, the process will open within the specified path as the working directory.&quot;</span>
        <span class="s2">&quot; Otherwise, a temporary directory will be created.&quot;</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># Underlying accepted types are str, bytes, PathLike[str], None</span>

    <span class="nd">@sync_compatible</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_status</span><span class="p">:</span> <span class="n">anyio</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">TaskStatus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ProcessResult&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Process cannot be run with empty command.&quot;</span><span class="p">)</span>

        <span class="n">_use_threaded_child_watcher</span><span class="p">()</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Open a subprocess to execute the flow run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opening process</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">working_dir_ctx</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;prefect&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>
            <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">working_dir_ctx</span> <span class="k">as</span> <span class="n">working_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Process</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> running command: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">working_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># We must add creationflags to a dict so it is only passed as a function</span>
            <span class="c1"># parameter on Windows, because the presence of creationflags causes</span>
            <span class="c1"># errors on Unix even if set to None</span>
            <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;creationflags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span>

            <span class="n">process</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_process</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                <span class="n">stream_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_output</span><span class="p">,</span>
                <span class="n">task_status</span><span class="o">=</span><span class="n">task_status</span><span class="p">,</span>
                <span class="n">task_status_handler</span><span class="o">=</span><span class="n">_infrastructure_pid_from_process</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_variables</span><span class="p">(),</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Use the pid for display if no name was given</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
            <span class="n">help_message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9</span><span class="p">:</span>
                <span class="n">help_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;This indicates that the process exited due to a SIGKILL signal. &quot;</span>
                    <span class="s2">&quot;Typically, this is either caused by manual cancellation or &quot;</span>
                    <span class="s2">&quot;high memory usage causing the operating system to &quot;</span>
                    <span class="s2">&quot;terminate the process.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">15</span><span class="p">:</span>
                <span class="n">help_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;This indicates that the process exited due to a SIGTERM signal. &quot;</span>
                    <span class="s2">&quot;Typically, this is caused by manual cancellation.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">247</span><span class="p">:</span>
                <span class="n">help_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;This indicates that the process was terminated due to high &quot;</span>
                    <span class="s2">&quot;memory usage.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="n">STATUS_CONTROL_C_EXIT</span>
            <span class="p">):</span>
                <span class="n">help_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Process was terminated due to a Ctrl+C or Ctrl+Break signal. &quot;</span>
                    <span class="s2">&quot;Typically, this is caused by manual cancellation.&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Process</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> exited with status code: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;; </span><span class="si">{</span><span class="n">help_message</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">help_message</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> exited cleanly.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ProcessResult</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infrastructure_pid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">grace_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">hostname</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">_parse_infrastructure_pid</span><span class="p">(</span><span class="n">infrastructure_pid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hostname</span> <span class="o">!=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">InfrastructureNotAvailable</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to kill process </span><span class="si">{</span><span class="n">pid</span><span class="si">!r}</span><span class="s2">: The process is running on a different host </span><span class="si">{</span><span class="n">hostname</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># In a non-windows environment first send a SIGTERM, then, after</span>
        <span class="c1"># `grace_seconds` seconds have passed subsequent send SIGKILL. In</span>
        <span class="c1"># Windows we use CTRL_BREAK_EVENT as SIGTERM is useless:</span>
        <span class="c1"># https://bugs.python.org/issue26350</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ProcessLookupError</span><span class="p">,</span> <span class="ne">WindowsError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InfrastructureNotFound</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to kill process </span><span class="si">{</span><span class="n">pid</span><span class="si">!r}</span><span class="s2">: The process was not found.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InfrastructureNotFound</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to kill process </span><span class="si">{</span><span class="n">pid</span><span class="si">!r}</span><span class="s2">: The process was not found.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Throttle how often we check if the process is still alive to keep</span>
            <span class="c1"># from making too many system calls in a short period of time.</span>
            <span class="n">check_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">grace_seconds</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">anyio</span><span class="o">.</span><span class="n">move_on_after</span><span class="p">(</span><span class="n">grace_seconds</span><span class="p">):</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">anyio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">check_interval</span><span class="p">)</span>

                    <span class="c1"># Detect if the process is still alive. If not do an early</span>
                    <span class="c1"># return as the process respected the SIGTERM from above.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
                        <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="c1"># We shouldn&#39;t ever end up here, but it&#39;s possible that the</span>
                <span class="c1"># process ended right after the check above.</span>
                <span class="k">return</span>

    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_variables</span><span class="p">(</span><span class="n">include_os_environ</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; </span><span class="se">\\\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="o">+</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_environment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_os_environ</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">os_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">if</span> <span class="n">include_os_environ</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># The base environment must override the current environment or</span>
        <span class="c1"># the Prefect settings context may not be respected</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">os_environ</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_environment</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">}</span>

        <span class="c1"># Drop null values allowing users to &quot;unset&quot; variables</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_base_flow_run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;prefect.engine&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="prefect.infrastructure.ProcessResult" class="doc doc-heading">
        <code>ProcessResult</code>


<a href="#prefect.infrastructure.ProcessResult" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="prefect.infrastructure.base.InfrastructureResult">InfrastructureResult</span></code></p>

  
      <p>Contains information about the final state of a completed process</p>


        <details class="quote">
          <summary>Source code in <code>prefect/infrastructure/process.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ProcessResult</span><span class="p">(</span><span class="n">InfrastructureResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains information about the final state of a completed process&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>




  </div>

  </div>

</div>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.prefect.io/slack/" target="_blank" rel="noopener" title="www.prefect.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://discourse.prefect.io/" target="_blank" rel="noopener" title="discourse.prefect.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M225.9 32C103.3 32 0 130.5 0 252.1 0 256 .1 480 .1 480l225.8-.2c122.7 0 222.1-102.3 222.1-223.9C448 134.3 348.6 32 225.9 32zM224 384c-19.4 0-37.9-4.3-54.4-12.1L88.5 392l22.9-75c-9.8-18.1-15.4-38.9-15.4-61 0-70.7 57.3-128 128-128s128 57.3 128 128-57.3 128-128 128z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/c/PrefectIO/videos" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://prefect.io/guide/" target="_blank" rel="noopener" title="prefect.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M168 80c-13.3 0-24 10.7-24 24v304c0 8.4-1.4 16.5-4.1 24H440c13.3 0 24-10.7 24-24V104c0-13.3-10.7-24-24-24H168zM72 432c13.3 0 24-10.7 24-24V104c0-39.8 32.2-72 72-72h272c39.8 0 72 32.2 72 72v304c0 39.8-32.2 72-72 72H72c-39.8 0-72-32.2-72-72V112c0-13.3 10.7-24 24-24s24 10.7 24 24v296c0 13.3 10.7 24 24 24zm104-296c0-13.3 10.7-24 24-24h208c13.3 0 24 10.7 24 24v80c0 13.3-10.7 24-24 24H200c-13.3 0-24-10.7-24-24v-80zm24 136h64c13.3 0 24 10.7 24 24s-10.7 24-24 24h-64c-13.3 0-24-10.7-24-24s10.7-24 24-24zm144 0h64c13.3 0 24 10.7 24 24s-10.7 24-24 24h-64c-13.3 0-24-10.7-24-24s10.7-24 24-24zm-144 80h64c13.3 0 24 10.7 24 24s-10.7 24-24 24h-64c-13.3 0-24-10.7-24-24s10.7-24 24-24zm144 0h64c13.3 0 24 10.7 24 24s-10.7 24-24 24h-64c-13.3 0-24-10.7-24-24s10.7-24 24-24z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/PrefectIO" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/company/prefect/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/PrefectHQ/prefect" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/prefecthq/prefect/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/prefect/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "toc.integrate", "navigation.tabs", "navigation.tabs.sticky", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.19047be9.min.js"></script>
      
        <script src="../../../js/termynal.js"></script>
      
        <script src="../../../js/custom.js"></script>
      
    
  </body>
</html>